# LINE予約Bot フロー概要

## 基本フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                      【予約〜確定フロー】                          │
└─────────────────────────────────────────────────────────────────┘

  ユーザー                    Bot / システム                   管理者
    │                            │                              │
    │  「予約」と送信            │                              │
    │ ─────────────────────────>│                              │
    │     予約フォームURL返信    │                              │
    │ <───────────────────────── │  [Reply/無料]                │
    │                            │                              │
    │  フォーム入力・送信        │                              │
    │ ═══════════════════════════>                              │
    │                            │                              │
    │    「承りました」通知      │   予約リクエスト通知         │
    │ <═══════════════════════════════════════════════════════> │
    │      [Push/課金1]          │       [Push/課金2]           │
    │                            │                              │
    │                            │   「受け付ける」押下         │
    │                            │ <─────────────────────────── │
    │                            │     「処理中...」            │
    │                            │ ─────────────────────────────>
    │                            │       [Reply/無料]           │
    │    「確定しました」通知    │   「確定」通知               │
    │ <═══════════════════════════════════════════════════════> │
    │      [Push/課金3]          │     [Push/課金4]             │
    │                            │                              │

  ━━━ Push通知（課金対象）
  ─── Reply（無料）
```

---

## アカウント構成

| アカウント | 用途 | 無料枠 |
|------------|------|--------|
| **お客様用Bot** | お客様への通知 | 200通/月 |
| **管理者用Bot** | 管理者への通知・承認操作 | 200通/月 |

→ **合計400通/月が無料**

---

## 課金発生ポイント

### 1予約あたりの課金メッセージ数

| シナリオ | お客様Bot | 管理者Bot | 合計 |
|----------|-----------|-----------|------|
| 通常フロー（フォーム→承認） | 2通 | 2通 | **4通** |
| 日時変更あり | 2通 | 3通 | **5通** |
| お断り | 2通 | 1通 | **3通** |

### 詳細内訳

**お客様用Bot（Push通知）**
| タイミング | 内容 |
|------------|------|
| フォーム送信時 | 「ご予約リクエストを承りました」 |
| 承認時 | 「ご予約が確定しました」 |
| お断り時 | お断り通知 |

**管理者用Bot（Push通知）**
| タイミング | 内容 |
|------------|------|
| フォーム送信時 | 予約リクエスト通知（承認ボタン付き） |
| 承認時 | 確定通知 |
| 日時変更時 | 新規リクエスト通知 |

---

## 無料で処理される部分（Reply API）

| ユーザーアクション | Bot応答 |
|-------------------|---------|
| 「予約」送信 | フォームURLボタン |
| 「予約確認」送信 | 予約一覧テキスト |
| 「ID」送信 | ユーザーID表示 |
| 承認/お断りボタン押下 | 「処理中...」表示 |

※ユーザーのアクション直後30秒以内の返信は無料

---

## 予約ステータス遷移

```
フォーム送信
    │
    ├─→ 空きあり → 「承認待ち」
    │                  │
    │           ┌──────┴──────┐
    │           ↓              ↓
    │       「確定」       「お断り」
    │
    └─→ 空きなし → 「日時調整中」
                        │
                   別の時間選択
                        ↓
                   「承認待ち」
```

---

## 自動機能

| 機能 | 頻度 | 内容 |
|------|------|------|
| フォーム日付更新 | 1時間ごと | 予約可能日を自動更新（満枠日を除外） |
| 空き時間チェック | 予約ごと | カレンダーと照合して空き確認 |
| 5時間ルール | 常時 | 予約時刻の5時間前まで受付 |

---

## 月間コスト目安（参考）

```
例：月100件の予約、90%承認、10%お断りの場合

【お客様用Bot】
  承認: 90件 × 2通 = 180通
  お断り: 10件 × 2通 = 20通
  ────────────────────────
  小計: 200通/月 → 無料枠内 ✓

【管理者用Bot】
  承認: 90件 × 2通 = 180通
  お断り: 10件 × 1通 = 10通
  ────────────────────────
  小計: 190通/月 → 無料枠内 ✓

━━━━━━━━━━━━━━━━━━━━━━━━
月100件なら両Bot合わせて無料枠内で運用可能
```

### 課金が発生する目安

| 月間予約数 | お客様Bot | 管理者Bot | 課金発生 |
|------------|-----------|-----------|----------|
| ~100件 | 200通 | 190通 | なし |
| ~110件 | 220通 | 210通 | 両方超過 |

※日時変更が多い場合は管理者Botが先に超過する傾向
