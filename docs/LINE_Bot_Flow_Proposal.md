# LINE予約Bot フロー概要

## 基本フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                      【予約〜確定フロー】                          │
└─────────────────────────────────────────────────────────────────┘

  ユーザー                    Bot / システム                   管理者
    │                            │                              │
    │  「予約」と送信            │                              │
    │ ─────────────────────────>│                              │
    │     予約フォームURL返信    │                              │
    │ <───────────────────────── │  [Reply/無料]                │
    │                            │                              │
    │  フォーム入力・送信        │                              │
    │ ═══════════════════════════>                              │
    │                            │                              │
    │    「承りました」通知      │   予約リクエスト通知         │
    │ <═══════════════════════════════════════════════════════> │
    │      [Push/課金1]          │       [Push/課金2]           │
    │                            │                              │
    │                            │   「受け付ける」押下         │
    │                            │ <─────────────────────────── │
    │                            │     「処理中...」            │
    │                            │ ─────────────────────────────>
    │                            │       [Reply/無料]           │
    │    「確定しました」通知    │   「確定」通知               │
    │ <═══════════════════════════════════════════════════════> │
    │      [Push/課金3]          │     [Push/課金4]             │
    │                            │                              │

  ━━━ Push通知（課金対象）
  ─── Reply（無料）
```

---

## 課金発生ポイント

### 1予約あたりの課金メッセージ数

| シナリオ | 課金メッセージ数 |
|----------|------------------|
| 通常フロー（フォーム→承認） | **4通** |
| 日時変更あり（弾かれ→再選択→承認） | **5通** |
| お断り | **3通** |

### 詳細

| タイミング | 宛先 | 内容 | 課金 |
|------------|------|------|------|
| フォーム送信時 | ユーザー | 「ご予約リクエストを承りました」 | 課金 |
| フォーム送信時 | 管理者 | 予約リクエスト通知 | 課金 |
| 承認時 | ユーザー | 「ご予約が確定しました」 | 課金 |
| 承認時 | 管理者 | 確定通知 | 課金 |
| お断り時 | ユーザー | お断り通知 | 課金 |

---

## 無料で処理される部分

| ユーザーアクション | Bot応答 | 課金 |
|-------------------|---------|------|
| 「予約」送信 | フォームURLボタン | 無料 |
| 「予約確認」送信 | 予約一覧テキスト | 無料 |
| 「ID」送信 | ユーザーID表示 | 無料 |
| ボタン押下直後 | 「処理中...」表示 | 無料 |

---

## 予約ステータス遷移

```
フォーム送信
    │
    ├─→ 空きあり → 「承認待ち」
    │                  │
    │           ┌──────┴──────┐
    │           ↓              ↓
    │       「確定」       「お断り」
    │
    └─→ 空きなし → 「日時調整中」
                        │
                   別の時間選択
                        ↓
                   「承認待ち」
```

---

## 自動機能

| 機能 | 頻度 | 内容 |
|------|------|------|
| フォーム日付更新 | 1時間ごと | 予約可能日を自動更新（満枠日を除外） |
| 空き時間チェック | 予約ごと | カレンダーと照合して空き確認 |
| 5時間ルール | 常時 | 予約時刻の5時間前まで受付 |

---

## 月間コスト目安（参考）

```
例：月100件の予約、90%承認、10%お断りの場合

承認: 90件 × 4通 = 360通
お断り: 10件 × 3通 = 30通
─────────────────────────
合計: 約390通/月

※LINE公式アカウントの無料枠（200通/月）超過分が課金対象
```

---

## 補足：Reply vs Push

| 種類 | 課金 | 使用条件 |
|------|------|----------|
| Reply API | 無料 | ユーザーのアクション直後（30秒以内）に返信 |
| Push API | 課金 | 任意タイミングでの通知 |

本Botでは、フォーム送信や承認処理がユーザーアクションと非同期のため、**Push API（課金）** を使用しています。
