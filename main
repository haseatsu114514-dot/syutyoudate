// ============================================
// ãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ« - main.gs
// ============================================

/**
 * GETãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»Webhookæ¤œè¨¼ç”¨ï¼‰
 */
function doGet(e) {
  console.log('=== doGetå—ä¿¡ ===');
  return ContentService.createTextOutput(JSON.stringify({ 
    status: 'ok', 
    message: 'LINE Bot is running',
    timestamp: new Date().toISOString()
  })).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Webhookå—ä¿¡å‡¦ç†ï¼ˆLINE Messaging APIï¼‰
 */
function doPost(e) {
  const startTime = Date.now();

  try {
    console.log('=== Webhookå—ä¿¡ ===');

    if (!e || !e.postData || !e.postData.contents) {
      console.error('Invalid request: no postData');
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Invalid request' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const data = JSON.parse(e.postData.contents);

    if (!data.events || !Array.isArray(data.events)) {
      console.error('Invalid request: no events array');
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No events' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    console.log('å—ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°:', data.events.length);

    data.events.forEach((event, index) => {
      try {
        console.log(`\nã‚¤ãƒ™ãƒ³ãƒˆ${index + 1}/${data.events.length}ã‚’å‡¦ç†ä¸­...`);
        handleEvent(event);
      } catch (eventError) {
        console.error(`ã‚¤ãƒ™ãƒ³ãƒˆ${index + 1}ã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, eventError);
        logError('ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼', eventError.toString());
      }
    });

    const duration = Date.now() - startTime;
    console.log(`\n=== Webhookå‡¦ç†å®Œäº† (${duration}ms) ===`);

    return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`doPost error (${duration}ms):`, error);
    logError('doPost error', error.toString());

    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */
function handleEvent(event) {
  console.log('ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—:', event.type);

  if (event.source && event.source.userId) {
    console.log('â˜…â˜…â˜… å—ä¿¡ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', event.source.userId, 'â˜…â˜…â˜…');
  }

  if (event.type === 'message' && event.message.type === 'text') {
    handleTextMessage(event);
  } else if (event.type === 'postback') {
    handlePostback(event);
  } else {
    console.log('æœªå¯¾å¿œã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—:', event.type);
  }
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ï¼ˆReply APIä½¿ç”¨ãƒ»ç„¡æ–™ï¼‰
 */
function handleTextMessage(event) {
  const userId = event.source.userId;
  const text = event.message.text.trim();
  const replyToken = event.replyToken;

  console.log('ãƒ†ã‚­ã‚¹ãƒˆå—ä¿¡:', text);

  // replyTokenãŒãªã„å ´åˆã¯å‡¦ç†ã—ãªã„
  if (!replyToken) {
    console.error('replyTokenãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  let replyMessages = [];

  // IDç¢ºèªã‚³ãƒãƒ³ãƒ‰
  if (text === 'ID' || text === 'id' || text === 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID' || text === 'ãƒã‚¤ID') {
    replyMessages = [{
      type: 'text',
      text: `ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:\n${userId}`
    }];
    logAction('IDç¢ºèª', userId, userId);
  }
  // äºˆç´„é–‹å§‹
  else if (text === 'äºˆç´„' || text === 'ã‚ˆã‚„ã') {
    replyMessages = [{
      type: 'template',
      altText: 'äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ',
      template: {
        type: 'buttons',
        text: 'ä¸‹è¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦ãã ã•ã„\n\nâ€»é€ä¿¡å¾Œã€æ‰¿èªã•ã‚Œã‚‹ã¨LINEã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™',
        actions: [
          {
            type: 'uri',
            label: 'äºˆç´„ã™ã‚‹',
            uri: buildBookingFormUrl(userId, true)
          }
        ]
      }
    }];
    logAction('äºˆç´„é–‹å§‹', userId, '');
  }
  // äºˆç´„ç¢ºèª
  else if (text === 'äºˆç´„ç¢ºèª' || text === 'äºˆç´„ä¸€è¦§') {
    // äºˆç´„ä¸€è¦§ã¯Reply APIã§è¿”ã™
    const bookings = getUserBookings(userId);
    
    if (!bookings || bookings.length === 0) {
      replyMessages = [{
        type: 'text',
        text: 'ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'
      }];
    } else {
      let message = 'ã€äºˆç´„ä¸€è¦§ã€‘\n';
      bookings.slice(0, 3).forEach((booking, index) => {
        message += `\n${index + 1}. ${booking.desiredDateTime}\n   ${booking.course} - ${booking.status}`;
      });
      if (bookings.length > 3) {
        message += `\n\nä»–${bookings.length - 3}ä»¶`;
      }
      replyMessages = [{ type: 'text', text: message }];
    }
    logAction('äºˆç´„ç¢ºèª', userId, `${bookings.length}ä»¶`);
  }
  // ãã®ä»– - å¿œç­”ã—ãªã„ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¯€ç´„ï¼‰
  else {
    console.log('æœªå¯¾å¿œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ - å¿œç­”ã‚¹ã‚­ãƒƒãƒ—:', text);
    return; // å¿œç­”ã—ãªã„ = ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¶ˆè²»ãªã—
  }

  // Reply APIã§è¿”ä¿¡ï¼ˆç„¡æ–™ï¼‰
  replyLineMessage(replyToken, replyMessages, CONFIG.LINE_CHANNEL_ACCESS_TOKEN);
}

/**
 * äºˆç´„ä¸€è¦§è¡¨ç¤º
 */
function showUserBookings(userId) {
  try {
    const bookings = getUserBookings(userId);

    if (!bookings || bookings.length === 0) {
      sendLineMessage(userId, [{
        type: 'text',
        text: 'ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\næ–°è¦äºˆç´„ã¯ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã‹ã‚‰è¡Œãˆã¾ã™ã€‚'
      }]);
      return;
    }

    let message = 'ã€ã‚ãªãŸã®äºˆç´„ä¸€è¦§ã€‘\n\n';

    bookings.forEach((booking, index) => {
      message += `${index + 1}. å—ä»˜ç•ªå·: ${booking.requestId}\n`;
      message += `   æ—¥æ™‚: ${booking.desiredDateTime}\n`;
      message += `   ã‚³ãƒ¼ã‚¹: ${booking.course}\n`;
      message += `   çŠ¶æ…‹: ${booking.status}\n`;

      if (booking.status === 'æ‰¿èªæ¸ˆã¿' && booking.approvedDateTime) {
        message += `   ç¢ºå®šæ—¥æ™‚: ${booking.approvedDateTime}\n`;
      }

      message += '\n';
    });

    sendLineMessage(userId, [{
      type: 'text',
      text: message
    }]);

    logAction('äºˆç´„ä¸€è¦§è¡¨ç¤º', userId, `${bookings.length}ä»¶`);

  } catch (error) {
    console.error('showUserBookings error:', error);
    sendLineMessage(userId, [{
      type: 'text',
      text: 'äºˆç´„ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
    }]);
  }
}

/**
 * ãƒã‚¹ãƒˆãƒãƒƒã‚¯å‡¦ç†ï¼ˆæœ€é€Ÿè¿”ä¿¡å¯¾å¿œï¼‰
 */
function handlePostback(event) {
  const userId = event.source.userId;
  const data = event.postback.data;
  const replyToken = event.replyToken;

  console.log('=== ãƒã‚¹ãƒˆãƒãƒƒã‚¯å‡¦ç†é–‹å§‹ ===');
  logAction('ãƒã‚¹ãƒˆãƒãƒƒã‚¯å—ä¿¡', userId, data);

  if (!data) return;

  const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;

  // æ‰¿èªå‡¦ç†
  if (data.startsWith('approve_')) {
    const requestId = data.replace('approve_', '');
    
    // â˜…æœ€é€Ÿè¿”ä¿¡
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `å‡¦ç†ä¸­...`
    }], adminToken);
    
    approveReservation(requestId, userId);
  }
  // ãŠæ–­ã‚Šå‡¦ç†
  else if (data.startsWith('reject_')) {
    const requestId = data.replace('reject_', '');
    
    // â˜…æœ€é€Ÿè¿”ä¿¡
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `å‡¦ç†ä¸­...`
    }], adminToken);
    
    rejectReservation(requestId, userId);
  }
}

/**
 * æœ€é€Ÿè¿”ä¿¡ç”¨ã®é–¢æ•°
 */
function replyLineMessage(replyToken, messages, token) {
  const url = 'https://api.line.me/v2/bot/message/reply';
  const accessToken = token || CONFIG.LINE_CHANNEL_ACCESS_TOKEN;
  
  UrlFetchApp.fetch(url, {
    'headers': {
      'Content-Type': 'application/json; charset=UTF-8',
      'Authorization': 'Bearer ' + accessToken,
    },
    'method': 'post',
    'payload': JSON.stringify({
      'replyToken': replyToken,
      'messages': messages,
    }),
    'muteHttpExceptions': true
  });
}

/**
 * äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ URLç”Ÿæˆ
 */
function buildBookingFormUrl(userId, isFirstTime) {
  const formId = isFirstTime ? CONFIG.FORM.BOOKING.ID : CONFIG.FORM.APPROVED.ID;
  const entryId = isFirstTime ? CONFIG.FORM.BOOKING.USER_ID_ENTRY : CONFIG.FORM.APPROVED.USER_ID_ENTRY;

  if (!isFirstTime) {
    return `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&entry.706843991=%E3%80%92&${entryId}=${encodeURIComponent(userId)}`;
  }

  return `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&${entryId}=${encodeURIComponent(userId)}`;
}

/**
 * äºˆç´„æ‰¿èªå‡¦ç†ï¼ˆè»½é‡åŒ–ç‰ˆï¼‰
 */
function approveReservation(requestId, adminUserId) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„æ‰¿èªå‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã‚¨ãƒ©ãƒ¼: å—ä»˜ç•ªå· ${requestId} ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`
      }], adminToken);
      return;
    }

    if (booking.status === 'æ‰¿èªæ¸ˆã¿') {
      console.log('ã™ã§ã«æ‰¿èªæ¸ˆã¿ã§ã™');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã“ã®äºˆç´„ã¯ã™ã§ã«æ‰¿èªæ¸ˆã¿ã§ã™\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    booking.status = 'æ‰¿èªæ¸ˆã¿';
    booking.approvedDateTime = booking.desiredDateTime;
    booking.approvedAt = new Date().toISOString();
    booking.approvedBy = adminUserId;
    booking.updatedAt = new Date().toISOString();

    const saved = saveBooking(requestId, booking);

    if (!saved) {
      console.error('äºˆç´„æ›´æ–°ã«å¤±æ•—');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    console.log('æ‰¿èªå‡¦ç†æˆåŠŸ:', requestId);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸é€šçŸ¥ï¼ˆæ‰¿èªå¾Œãƒ•ã‚©ãƒ¼ãƒ URLã‚’å«ã‚€ï¼‰
    const approvedFormUrl = buildBookingFormUrl(booking.userId, false);

    const userMessage = {
      type: 'template',
      altText: 'äºˆç´„æ‰¿èªã®ãŠçŸ¥ã‚‰ã›',
      template: {
        type: 'buttons',
        text: `ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èªã„ãŸã—ã¾ã—ãŸ\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${booking.approvedDateTime}\n${booking.course}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nã¾ã äºˆç´„ã¯ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“\n\nä¸‹è¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ æƒ…å ±(ãŠåå‰ãƒ»ã”é€£çµ¡å…ˆãƒ»ã”ä½æ‰€)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`,
        actions: [
          {
            type: 'uri',
            label: 'è¿½åŠ æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹',
            uri: approvedFormUrl
          }
        ]
      }
    };

    sendLineMessage(booking.userId, [userMessage]);

    // ç®¡ç†è€…ã¸ç¢ºèªé€šçŸ¥ï¼ˆç°¡æ½”ç‰ˆï¼‰
    const adminMessage = `æ‰¿èªå®Œäº†\n\nå—ä»˜ç•ªå·\n${requestId}\n\næ—¥æ™‚\n${booking.approvedDateTime}\n\nã‚³ãƒ¼ã‚¹\n${booking.course}\n\nå ´æ‰€\n${booking.location}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿½åŠ æƒ…å ±ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¾ã—ãŸ`;

    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    sendLineMessage(adminUserId, [{
      type: 'text',
      text: adminMessage
    }], adminToken);

    logAction('äºˆç´„æ‰¿èª', adminUserId, requestId);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„æ‰¿èªå‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`approveReservation error (${duration}ms):`, error);
    logError('äºˆç´„æ‰¿èªã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

/**
 * äºˆç´„ãŠæ–­ã‚Šå‡¦ç†
 */
function rejectReservation(requestId, adminUserId) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„ãŠæ–­ã‚Šå‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã‚¨ãƒ©ãƒ¼: å—ä»˜ç•ªå· ${requestId} ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`
      }], adminToken);
      return;
    }

    if (booking.status === 'ãŠæ–­ã‚Š') {
      console.log('ã™ã§ã«ãŠæ–­ã‚Šæ¸ˆã¿ã§ã™');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã“ã®äºˆç´„ã¯ã™ã§ã«ãŠæ–­ã‚Šæ¸ˆã¿ã§ã™\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    booking.status = 'ãŠæ–­ã‚Š';
    booking.rejectedAt = new Date().toISOString();
    booking.rejectedBy = adminUserId;
    booking.updatedAt = new Date().toISOString();

    const saved = saveBooking(requestId, booking);

    if (!saved) {
      console.error('äºˆç´„æ›´æ–°ã«å¤±æ•—');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    console.log('ãŠæ–­ã‚Šå‡¦ç†æˆåŠŸ:', requestId);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸é€šçŸ¥ï¼ˆç®¡ç†botãƒˆãƒ¼ã‚¯ãƒ³ã§é€ä¿¡ï¼‰
    const userMessage = `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“\n\nä»¥ä¸‹ã®äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãŠå—ã‘ã§ãã¾ã›ã‚“ã§ã—ãŸ\n\nå—ä»˜ç•ªå·\n${requestId}\n\nå¸Œæœ›æ—¥æ™‚\n${booking.desiredDateTime}\n\nã‚³ãƒ¼ã‚¹\n${booking.course}\n\nåˆ¥ã®æ—¥æ™‚ã§ãŠè©¦ã—ãã ã•ã„`;

    sendLineMessage(booking.userId, [{
      type: 'text',
      text: userMessage
    }]);

    // ç®¡ç†è€…ã¸ç¢ºèªé€šçŸ¥
    const adminMessage = `ãŠæ–­ã‚Šå®Œäº†\n\nå—ä»˜ç•ªå·\n${requestId}\n\næ—¥æ™‚\n${booking.desiredDateTime}\n\nã‚³ãƒ¼ã‚¹\n${booking.course}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã—ã¾ã—ãŸ`;

    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    sendLineMessage(adminUserId, [{
      type: 'text',
      text: adminMessage
    }], adminToken);

    logAction('äºˆç´„ãŠæ–­ã‚Š', adminUserId, requestId);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„ãŠæ–­ã‚Šå‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`rejectReservation error (${duration}ms):`, error);
    logError('äºˆç´„ãŠæ–­ã‚Šã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

// ============================================
// Googleãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼ï¼ˆçµ±åˆç‰ˆï¼‰
// ============================================

/**
 * ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°
 */
function onFormSubmit(e) {
  try {
    const sheetName = e.range.getSheet().getName();
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ å›ç­”å—ä¿¡ ===');
    console.log('ã‚·ãƒ¼ãƒˆå:', sheetName);

    if (sheetName === 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1') {
      console.log('â†’ åˆå›äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã¨åˆ¤å®š');
      handleInitialFormSubmit(e);
    } else if (sheetName === 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 2') {
      console.log('â†’ æ‰¿èªå¾Œãƒ•ã‚©ãƒ¼ãƒ ã¨åˆ¤å®š');
      handleApprovedFormSubmit(e);
    } else {
      console.error('ä¸æ˜ãªã‚·ãƒ¼ãƒˆå:', sheetName);
      logError('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¨ãƒ©ãƒ¼', `ä¸æ˜ãªã‚·ãƒ¼ãƒˆ: ${sheetName}`);
    }

  } catch (error) {
    console.error('onFormSubmit error:', error);
    logError('onFormSubmit ã‚¨ãƒ©ãƒ¼', error.toString());

    try {
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(CONFIG.ADMIN_USER_ID, [{
        type: 'text',
        text: `ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼\n\nãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\nã‚¨ãƒ©ãƒ¼: ${error.toString()}\n\nå®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„`
      }], adminToken);
    } catch (notifyError) {
      console.error('ã‚¨ãƒ©ãƒ¼é€šçŸ¥å¤±æ•—:', notifyError);
    }
  }
}

/**
 * äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµç‰ˆï¼‰
 * å…¨æƒ…å ±ã‚’1å›ã®ãƒ•ã‚©ãƒ¼ãƒ ã§å–å¾—ã—ã€æ‰¿èªå¾Œã¯å³ç¢ºå®š
 */
function handleInitialFormSubmit(e) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†é–‹å§‹ ===');

    const data = e.namedValues;

    // åŸºæœ¬æƒ…å ±
    const userId = data['ç®¡ç†ç”¨ ID'] ? data['ç®¡ç†ç”¨ ID'][0] : null;
    const name = data['ãŠåå‰'] ? data['ãŠåå‰'][0] : 'ï¼ˆæœªå…¥åŠ›ï¼‰';
    const desiredDate = data['å¸Œæœ›æ—¥'] ? data['å¸Œæœ›æ—¥'][0] : null;
    const desiredTime = data['å¸Œæœ›æ™‚åˆ»'] ? data['å¸Œæœ›æ™‚åˆ»'][0] : null;
    const course = data['ã‚³ãƒ¼ã‚¹'] ? data['ã‚³ãƒ¼ã‚¹'][0] : null;
    const location = data['å‡ºå¼µå ´æ‰€'] ? data['å‡ºå¼µå ´æ‰€'][0] : null;

    // è¿½åŠ æƒ…å ±ï¼ˆé›»è©±ãƒ»ä½æ‰€ï¼‰
    const phone = data['é›»è©±ç•ªå·'] ? data['é›»è©±ç•ªå·'][0] : null;
    const postalCode = data['éƒµä¾¿ç•ªå·'] ? data['éƒµä¾¿ç•ªå·'][0] : '';
    const address = data['ã”ä½æ‰€'] ? data['ã”ä½æ‰€'][0] : null;

    console.log('å—ä¿¡ãƒ‡ãƒ¼ã‚¿ - userId:', userId, 'date:', desiredDate, 'time:', desiredTime);
    console.log('è¿½åŠ æƒ…å ± - phone:', phone ? 'å…¥åŠ›ã‚ã‚Š' : 'ãªã—', 'address:', address ? 'å…¥åŠ›ã‚ã‚Š' : 'ãªã—');

    if (!userId || !desiredDate || !desiredTime || !course || !location || !phone || !address) {
      console.error('å¿…é ˆé …ç›®ä¸è¶³ - userId:', userId, 'date:', desiredDate, 'time:', desiredTime, 'course:', course, 'location:', location, 'phone:', phone, 'address:', address);
      return;
    }

    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ•´å½¢
    let dateStr = desiredDate;
    if (desiredDate instanceof Date || typeof desiredDate === 'object') {
      const d = new Date(desiredDate);
      dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    const desiredDateTime = `${dateStr} ${desiredTime}`;
    const requestId = generateRequestId();

    // â˜…â˜…â˜… é«˜é€Ÿã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ â˜…â˜…â˜…
    const availability = checkCalendarFast(new Date(desiredDateTime), course);

    // æ—¢ã«äºˆç´„ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆ â†’ ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã§ç©ºãæ™‚é–“ã‚’ææ¡ˆ
    if (!availability.available) {
      console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«äºˆç´„ã‚ã‚Š - ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã§æ•‘æ¸ˆ');

      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜ï¼ˆæ—¥æ™‚èª¿æ•´ä¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
      const tempBookingData = {
        requestId: requestId,
        userId: userId,
        userName: name,
        desiredDateTime: desiredDateTime,
        course: course,
        location: location,
        phone: phone,
        postalCode: postalCode,
        address: address,
        status: 'æ—¥æ™‚èª¿æ•´ä¸­',
        originalDateTime: desiredDateTime,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      saveBooking(requestId, tempBookingData);

      // ç©ºãæ™‚é–“ã‚’å–å¾—
      const suggestions = findAvailableSlots(new Date(desiredDateTime), course);

      if (suggestions.length > 0) {
        // ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã§ç©ºãæ™‚é–“ã‚’ææ¡ˆ
        const quickReplyItems = suggestions.slice(0, 10).map(slot => ({
          type: 'action',
          action: {
            type: 'postback',
            label: slot.replace(/^\d{4}-/, '').replace(' ', ' '),
            data: `reschedule_${requestId}_${slot}`
          }
        }));

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚‚è¿½åŠ 
        quickReplyItems.push({
          type: 'action',
          action: {
            type: 'postback',
            label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
            data: `cancel_reschedule_${requestId}`
          }
        });

        const rescheduleMessage = {
          type: 'text',
          text: `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n${availability.reason}\n\nä»¥ä¸‹ã®ç©ºãæ™‚é–“ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿ`,
          quickReply: {
            items: quickReplyItems
          }
        };

        sendLineMessage(userId, [rescheduleMessage]);
        logAction('æ—¥æ™‚èª¿æ•´ææ¡ˆ', userId, `${requestId} - ç©ºã${suggestions.length}ä»¶`);
      } else {
        // ç©ºãæ™‚é–“ãŒãªã„å ´åˆ
        const noSlotMessage = `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n${availability.reason}\n\næœ¬æ—¥ã®ç©ºãæ™‚é–“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nåˆ¥ã®æ—¥ã§å†åº¦ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚`;
        sendLineMessage(userId, [{ type: 'text', text: noSlotMessage }]);
        logAction('äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå´ä¸‹', userId, `${desiredDateTime} - ç©ºããªã—`);
      }

      const duration = Date.now() - startTime;
      console.log(`=== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é‡è¤‡ - ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤é€ä¿¡å®Œäº† (${duration}ms) ===`);
      return;
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒç©ºã„ã¦ã„ã‚‹å ´åˆ
    console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç©ºãã‚ã‚Š - äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘');

    // â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã¯çœç•¥ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ç”»é¢ã§ç¢ºèªã—ã¦ã‚‚ã‚‰ã†ï¼‰
    // â†’ 1é€šç¯€ç´„ + å‡¦ç†é«˜é€ŸåŒ–

    // â˜… äºˆç´„ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆå…¨æƒ…å ±ã‚’å«ã‚€ï¼‰
    saveBooking(requestId, {
      requestId: requestId,
      userId: userId,
      userName: name,
      desiredDateTime: desiredDateTime,
      course: course,
      location: location,
      phone: phone,
      postalCode: postalCode,
      address: address,
      status: 'æ‰¿èªå¾…ã¡',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });

    // â˜… ç®¡ç†è€…ã¸ã®é€šçŸ¥ï¼ˆå…¨æƒ…å ±ã‚’è¡¨ç¤ºï¼‰
    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;

    const adminMessages = [
      {
        type: 'text',
        text: `æ–°è¦äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `${name} æ§˜\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
              `ğŸ“… ${dateStr} ${desiredTime}\n` +
              `ğŸ’¼ ${course}\n\n` +
              `ğŸ“ å‡ºå¼µå ´æ‰€\n${location}\n\n` +
              `ğŸ“ ${phone}\n` +
              `ğŸ  ${postalCode}\n${address}\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
      },
      {
        type: 'template',
        altText: 'äºˆç´„ã®ç¢ºèª',
        template: {
          type: 'confirm',
          text: `ã“ã®äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã™ã‹ï¼Ÿ`,
          actions: [
            {
              type: 'postback',
              label: 'å—ã‘ä»˜ã‘ã‚‹',
              data: `approve_${requestId}`
            },
            {
              type: 'postback',
              label: 'ãŠæ–­ã‚Šã™ã‚‹',
              data: `reject_${requestId}`
            }
          ]
        }
      }
    ];

    const adminSent = sendLineMessage(CONFIG.ADMIN_USER_ID, adminMessages, adminToken);
    console.log('ç®¡ç†è€…é€šçŸ¥é€ä¿¡çµæœ:', adminSent ? 'æˆåŠŸ' : 'å¤±æ•—');

    logAction('äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡', userId, requestId);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    console.error(`handleInitialFormSubmit error:`, error);
    logError('äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

/**
 * æ‰¿èªå¾Œãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ï¼ˆè¡¨ç¤ºæ”¹å–„ç‰ˆï¼‰
 */
function handleApprovedFormSubmit(e) {
  const startTime = Date.now();

  try {
    console.log('=== æ‰¿èªå¾Œãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†é–‹å§‹ ===');

    const data = e.namedValues;
    
    const userId = data['ç®¡ç†ç”¨ ID'] ? data['ç®¡ç†ç”¨ ID'][0] : null;
    const phone = data['é›»è©±ç•ªå·'] ? data['é›»è©±ç•ªå·'][0] : null;
    const postalCode = data['éƒµä¾¿ç•ªå·'] ? data['éƒµä¾¿ç•ªå·'][0] : null;
    const address = data['ã”ä½æ‰€'] ? data['ã”ä½æ‰€'][0] : null;

    console.log('userId:', userId);
    console.log('phone:', phone);
    console.log('postalCode:', postalCode);
    console.log('address:', address);

    if (!userId || !phone || !address) {
      console.error('å¿…é ˆé …ç›®ä¸è¶³');
      return;
    }

    // æœ€æ–°ã®æ‰¿èªæ¸ˆã¿äºˆç´„ã‚’æ¤œç´¢
    const booking = findLatestApprovedBookingByUserId(userId);

    if (!booking) {
      console.error('æ‰¿èªæ¸ˆã¿äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    const name = booking.userName || 'ï¼ˆæœªè¨­å®šï¼‰';

    // è¿½åŠ æƒ…å ±ã‚’ä¿å­˜
    booking.additionalInfo = {
      phone: phone,
      postalCode: postalCode,
      address: address,
      submittedAt: new Date().toISOString()
    };
    booking.status = 'ç¢ºå®š';
    booking.updatedAt = new Date().toISOString();

    saveBooking(booking.requestId, booking);

    // Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²
    const calendarAdded = addToCalendar(booking.approvedDateTime, booking.course, booking.requestId, name);

    // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ç¢ºå®šé€šçŸ¥ï¼ˆç®¡ç†botãƒˆãƒ¼ã‚¯ãƒ³ã§é€ä¿¡ï¼‰
    const userMessage = `ã”äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸ\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `ğŸ“… æ—¥æ™‚\n${booking.approvedDateTime}\n\n` +
                       `ğŸ’¼ ã‚³ãƒ¼ã‚¹\n${booking.course}\n\n` +
                       `ğŸ  å½“æ—¥ãŠä¼ºã„ã™ã‚‹ä½æ‰€\n${postalCode}\n${address}\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                       `${name} æ§˜\n\n` +
                       `å½“æ—¥ãŠä¼ºã„ã—ã¾ã™\nã”ä¸æ˜ç‚¹ã¯ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„`;

    sendLineMessage(userId, [{ type: 'text', text: userMessage }]);

    // â˜… ç®¡ç†è€…ã¸ã®ç¢ºå®šé€šçŸ¥ï¼ˆä½æ‰€ã‚’å«ã‚€è©³ç´°ç‰ˆï¼‰
    const adminMessage = `âœ… äºˆç´„ç¢ºå®š\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `ğŸ“… æ—¥æ™‚\n${booking.approvedDateTime}\n\n` +
                       `ğŸ’¼ ã‚³ãƒ¼ã‚¹\n${booking.course}\n\n` +
                       `ğŸ‘¤ ãŠåå‰\n${name} æ§˜\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                       `ğŸ“ é›»è©±ç•ªå·\n${phone}\n\n` +
                       `ğŸ  ä½æ‰€\n${postalCode}\n${address}\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `å—ä»˜ç•ªå·: ${booking.requestId}\n` +
                       `ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: ${calendarAdded ? 'âœ“' : 'âœ—'}`;

    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    sendLineMessage(CONFIG.ADMIN_USER_ID, [{ type: 'text', text: adminMessage }], adminToken);

    logAction('äºˆç´„ç¢ºå®š', userId, booking.requestId);

    const duration = Date.now() - startTime;
    console.log(`=== æ‰¿èªå¾Œãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`handleApprovedFormSubmit error (${duration}ms):`, error);
    logError('æ‰¿èªå¾Œãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã‚¨ãƒ©ãƒ¼', error.toString());
  }
}
