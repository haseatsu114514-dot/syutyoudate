// ============================================
// ãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ« - main.gs
// ============================================

/**
 * GETãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»Webhookæ¤œè¨¼ç”¨ï¼‰
 */
function doGet(e) {
  console.log('=== doGetå—ä¿¡ ===');
  return ContentService.createTextOutput(JSON.stringify({ 
    status: 'ok', 
    message: 'LINE Bot is running',
    timestamp: new Date().toISOString()
  })).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Webhookå—ä¿¡å‡¦ç†ï¼ˆLINE Messaging APIï¼‰
 */
function doPost(e) {
  const startTime = Date.now();

  try {
    console.log('=== Webhookå—ä¿¡ ===');

    if (!e || !e.postData || !e.postData.contents) {
      console.error('Invalid request: no postData');
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Invalid request' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const data = JSON.parse(e.postData.contents);

    if (!data.events || !Array.isArray(data.events)) {
      console.error('Invalid request: no events array');
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No events' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    console.log('å—ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°:', data.events.length);

    data.events.forEach((event, index) => {
      try {
        console.log(`\nã‚¤ãƒ™ãƒ³ãƒˆ${index + 1}/${data.events.length}ã‚’å‡¦ç†ä¸­...`);
        handleEvent(event);
      } catch (eventError) {
        console.error(`ã‚¤ãƒ™ãƒ³ãƒˆ${index + 1}ã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, eventError);
        logError('ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼', eventError.toString());
      }
    });

    const duration = Date.now() - startTime;
    console.log(`\n=== Webhookå‡¦ç†å®Œäº† (${duration}ms) ===`);

    return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`doPost error (${duration}ms):`, error);
    logError('doPost error', error.toString());

    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */
function handleEvent(event) {
  console.log('ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—:', event.type);

  if (event.source && event.source.userId) {
    console.log('â˜…â˜…â˜… å—ä¿¡ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', event.source.userId, 'â˜…â˜…â˜…');
  }

  if (event.type === 'message' && event.message.type === 'text') {
    handleTextMessage(event);
  } else if (event.type === 'postback') {
    handlePostback(event);
  } else {
    console.log('æœªå¯¾å¿œã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—:', event.type);
  }
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ï¼ˆReply APIä½¿ç”¨ãƒ»ç„¡æ–™ï¼‰
 */
function handleTextMessage(event) {
  const userId = event.source.userId;
  const text = event.message.text.trim();
  const replyToken = event.replyToken;

  console.log('ãƒ†ã‚­ã‚¹ãƒˆå—ä¿¡:', text);

  // replyTokenãŒãªã„å ´åˆã¯å‡¦ç†ã—ãªã„
  if (!replyToken) {
    console.error('replyTokenãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  let replyMessages = [];

  // IDç¢ºèªã‚³ãƒãƒ³ãƒ‰
  if (text === 'ID' || text === 'id' || text === 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID' || text === 'ãƒã‚¤ID') {
    replyMessages = [{
      type: 'text',
      text: `ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:\n${userId}`
    }];
    logAction('IDç¢ºèª', userId, userId);
  }

  // äºˆç´„é–‹å§‹
  else if ((text.includes('äºˆç´„') || text.includes('ã‚ˆã‚„ã')) && !text.includes('ç¢ºèª') && !text.includes('ä¸€è¦§')) {
    replyMessages = [{
      type: 'template',
      altText: 'äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ',
      template: {
          text: 'ä¸‹è¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰äºˆç´„ã‚’é–‹å§‹ã—ã¾ã™',
        actions: [
          {
            type: 'message',
            label: 'äºˆç´„ã™ã‚‹',
            text: 'äºˆç´„'
          }
        ]
      }
    }];
     // æ—¢å­˜ã®äºˆç´„é–‹å§‹ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒˆãƒªã‚¬ãƒ¼ï¼‰ã«æµã™
     try {
       startReservationFlow(userId, replyToken);
     } catch (e) {
       console.error('startReservationFlow error:', e);
       replyLineMessage(replyToken, [{
         type: 'text',
         text: `ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n${e.toString()}`
       }]);
     }
     return; // ã“ã“ã§çµ‚äº†ï¼ˆstartReservationFlowå†…ã§è¿”ä¿¡ã™ã‚‹ãŸã‚ï¼‰
  }
  // äºˆç´„ç¢ºèª
  else if (text === 'äºˆç´„ç¢ºèª' || text === 'äºˆç´„ä¸€è¦§') {
    // äºˆç´„ä¸€è¦§ã¯Reply APIã§è¿”ã™
    const bookings = getUserBookings(userId);
    
    if (!bookings || bookings.length === 0) {
      replyMessages = [{
        type: 'text',
        text: 'ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'
      }];
    } else {
      let message = 'ã€äºˆç´„ä¸€è¦§ã€‘\n';
      bookings.slice(0, 3).forEach((booking, index) => {
        message += `\n${index + 1}. ${booking.desiredDateTime}\n   ${booking.course} - ${booking.status}`;
      });
      if (bookings.length > 3) {
        message += `\n\nä»–${bookings.length - 3}ä»¶`;
      }
      replyMessages = [{ type: 'text', text: message }];
    }
    logAction('äºˆç´„ç¢ºèª', userId, `${bookings.length}ä»¶`);
  }

  // ãã®ä»– - å¿œç­”ã—ãªã„ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¯€ç´„ï¼‰
  else {
    console.log('æœªå¯¾å¿œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ - å¿œç­”ã‚¹ã‚­ãƒƒãƒ—:', text);
    return; // å¿œç­”ã—ãªã„ = ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¶ˆè²»ãªã—
  }

  // Reply APIã§è¿”ä¿¡ï¼ˆç„¡æ–™ï¼‰
  replyLineMessage(replyToken, replyMessages, CONFIG.LINE_CHANNEL_ACCESS_TOKEN);
}

/**
 * äºˆç´„ä¸€è¦§è¡¨ç¤º
 */
function showUserBookings(userId) {
  try {
    const bookings = getUserBookings(userId);

    if (!bookings || bookings.length === 0) {
      sendLineMessage(userId, [{
        type: 'text',
        text: 'ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\næ–°è¦äºˆç´„ã¯ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã‹ã‚‰è¡Œãˆã¾ã™ã€‚'
      }]);
      return;
    }

    let message = 'ã€ã‚ãªãŸã®äºˆç´„ä¸€è¦§ã€‘\n\n';

    bookings.forEach((booking, index) => {
      message += `${index + 1}. å—ä»˜ç•ªå·: ${booking.requestId}\n`;
      message += `   æ—¥æ™‚: ${booking.desiredDateTime}\n`;
      message += `   ã‚³ãƒ¼ã‚¹: ${booking.course}\n`;
      message += `   çŠ¶æ…‹: ${booking.status}\n`;

      if (booking.status === 'æ‰¿èªæ¸ˆã¿' && booking.approvedDateTime) {
        message += `   ç¢ºå®šæ—¥æ™‚: ${booking.approvedDateTime}\n`;
      }

      message += '\n';
    });

    sendLineMessage(userId, [{
      type: 'text',
      text: message
    }]);

    logAction('äºˆç´„ä¸€è¦§è¡¨ç¤º', userId, `${bookings.length}ä»¶`);

  } catch (error) {
    console.error('showUserBookings error:', error);
    sendLineMessage(userId, [{
      type: 'text',
      text: 'äºˆç´„ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
    }]);
  }
}

/**
 * ãƒã‚¹ãƒˆãƒãƒƒã‚¯å‡¦ç†ï¼ˆæœ€é€Ÿè¿”ä¿¡å¯¾å¿œï¼‰
 */
function handlePostback(event) {
  const userId = event.source.userId;
  const data = event.postback.data;
  const replyToken = event.replyToken;

  console.log('=== ãƒã‚¹ãƒˆãƒãƒƒã‚¯å‡¦ç†é–‹å§‹ ===');
  logAction('ãƒã‚¹ãƒˆãƒãƒƒã‚¯å—ä¿¡', userId, data);

  if (!data) return;

  const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;

  // æ‰¿èªå‡¦ç†ï¼ˆç®¡ç†è€…ï¼‰
  if (data.startsWith('approve_')) {
    const requestId = data.replace('approve_', '');

    // â˜…æœ€é€Ÿè¿”ä¿¡
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `å‡¦ç†ä¸­...`
    }], adminToken);

    approveReservation(requestId, userId);
  }
  // ãŠæ–­ã‚Šå‡¦ç†ï¼ˆç®¡ç†è€…ï¼‰
  else if (data.startsWith('reject_')) {
    const requestId = data.replace('reject_', '');

    // â˜…æœ€é€Ÿè¿”ä¿¡
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `å‡¦ç†ä¸­...`
    }], adminToken);

    rejectReservation(requestId, userId);
  }
  // æ—¥æ™‚å¤‰æ›´å‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ - å¼¾ã‹ã‚Œæ•‘æ¸ˆç”¨ï¼‰
  else if (data.startsWith('reschedule_')) {
    // reschedule_{requestId}_{datetime}
    // å¤ã„ãƒ•ãƒ­ãƒ¼ã¨ã®äº’æ›æ€§ã®ãŸã‚æ®‹ã™ãŒã€æ–°ã—ã„ãƒ•ãƒ­ãƒ¼ã§ã¯ select_time_ ã‚’ä½¿ç”¨
    const parts = data.replace('reschedule_', '').split('_');
    const requestId = parts[0];
    const newDateTime = parts.slice(1).join('_');

    // â˜…æœ€é€Ÿè¿”ä¿¡
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `${newDateTime} ã§äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã¾ã™...`
    }]);

    handleReschedule(requestId, newDateTime, userId);
  }
  // â˜… ã‚³ãƒ¼ã‚¹é¸æŠ (æ–°ãƒ•ãƒ­ãƒ¼)
  else if (data.startsWith('select_course_')) {
    // select_course_{requestId}_{courseName}
    const parts = data.replace('select_course_', '').split('_');
    const requestId = parts[0];
    const courseName = parts.slice(1).join('_');

    handleCourseSelection(replyToken, requestId, courseName, userId);
  }
  // â˜… æ—¥ä»˜é¸æŠ
  else if (data.startsWith('select_date_')) {
    const parts = data.replace('select_date_', '').split('_');
    const requestId = parts[0];
    const dateStr = parts.slice(1).join('_');

    handleDateSelection(replyToken, requestId, dateStr, userId);
  }
  // â˜… æ—¥ä»˜æ¬¡ã¸ (ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³)
  else if (data.startsWith('next_dates_')) {
    // next_dates_{requestId}_{offset}
    const parts = data.replace('next_dates_', '').split('_');
    const requestId = parts[0];
    const offset = parseInt(parts[1]);

    showDateSelection(requestId, offset, replyToken, userId);
  }
  // â˜… æ™‚é–“é¸æŠ
  else if (data.startsWith('select_time_')) {
    const parts = data.replace('select_time_', '').split('_');
    const requestId = parts[0];
    const timeStr = parts.slice(1).join(':');

    handleTimeSelection(requestId, timeStr, userId, replyToken);
  }
  // â˜… æ™‚é–“æ¬¡ã¸ (ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³)
  else if (data.startsWith('next_times_')) {
    // next_times_{requestId}_{dateStr}_{offset}
    // dateStrã«_ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨é¢å€’ãªã®ã§ã€requestIdã‹ã‚‰å–å¾—ã—ãŸæ–¹ãŒå®‰å…¨ã ãŒã€
    // ã“ã“ã§ã¯requestIdã‹ã‚‰bookingã‚’å–å¾—ã§ãã‚‹ã®ã§offsetã ã‘ã‚ã‚Œã°ã„ã„ãŒã€
    // statelessã«ã™ã‚‹ãªã‚‰dateStrã‚‚ã„ã‚‹ã€‚
    // requestIdãŒã‚ã‚Œã°bookingã‹ã‚‰tempDateStrãŒå–ã‚Œã‚‹ã¯ãšãªã®ã§offsetã ã‘ã§ã„ãã€‚
    const parts = data.replace('next_times_', '').split('_');
    const requestId = parts[0];
    const offset = parseInt(parts[1]);

    // dateStrã¯bookingã‹ã‚‰å–ã‚‹
    const booking = getBooking(requestId);
    if(booking && booking.tempDateStr) {
       showTimeSelection(requestId, booking.tempDateStr, offset, replyToken, userId);
    } else {
       replyLineMessage(replyToken, [{type:'text', text:'ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œã§ã™ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚'}]);
    }
  }
  // æ—¥æ™‚å¤‰æ›´ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
  else if (data.startsWith('cancel_reschedule_')) {
    const requestId = data.replace('cancel_reschedule_', '');

    // â˜…æœ€é€Ÿè¿”ä¿¡
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚\n\næœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å†åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`
    }]);

    // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã¾ãŸã¯ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«æ›´æ–°
    handleRescheduleCancel(requestId, userId);
  }
  // â˜… ãƒ•ãƒ­ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚³ãƒ¼ã‚¹é¸æŠæ™‚ï¼‰
  else if (data.startsWith('cancel_flow_')) {
     const requestId = data.replace('cancel_flow_', '');
     replyLineMessage(replyToken, [{
       type: 'text',
       text: 'äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚'
     }]);
     // å¿…è¦ãªã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  }
  // â˜… ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹
  else if (data.startsWith('back_to_course_')) {
     const requestId = data.replace('back_to_course_', '');
     showCourseSelection(requestId, userId, replyToken);
  }
  // â˜… æ—¥ä»˜é¸æŠã«æˆ»ã‚‹
  else if (data.startsWith('back_to_date_')) {
     const requestId = data.replace('back_to_date_', '');
     showDateSelection(requestId, 0, replyToken, userId);
  }
  // â˜… ä»®æŠ¼ã•ãˆã‚­ãƒ£ãƒ³ã‚»ãƒ«
  else if (data.startsWith('cancel_hold_')) {
     const requestId = data.replace('cancel_hold_', '');
     handleCancelHold(requestId, userId, replyToken);
  }
}

/**
 * æ—¥æ™‚å¤‰æ›´å‡¦ç†ï¼ˆå¼¾ã‹ã‚Œæ•‘æ¸ˆç”¨ï¼‰
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã§æ–°ã—ã„æ—¥æ™‚ã‚’é¸æŠã—ãŸæ™‚ã®å‡¦ç†
 */
function handleReschedule(requestId, newDateTime, userId) {
  const startTime = Date.now();

  try {
    console.log('=== æ—¥æ™‚å¤‰æ›´å‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId, 'æ–°æ—¥æ™‚:', newDateTime);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      sendLineMessage(userId, [{
        type: 'text',
        text: `ã‚¨ãƒ©ãƒ¼: äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚`
      }]);
      return;
    }

    // æ—¥æ™‚ã‚’æ›´æ–°
    booking.desiredDateTime = newDateTime;
    booking.status = 'æ‰¿èªå¾…ã¡';
    booking.updatedAt = new Date().toISOString();

    const saved = saveBooking(requestId, booking);

    if (!saved) {
      console.error('äºˆç´„æ›´æ–°ã«å¤±æ•—');
      sendLineMessage(userId, [{
        type: 'text',
        text: `ã‚¨ãƒ©ãƒ¼: äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`
      }]);
      return;
    }

    // ç®¡ç†è€…ã«æ‰¿èªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    const name = booking.userName || 'ï¼ˆæœªè¨­å®šï¼‰';

    const adminMessages = [
      {
        type: 'text',
        text: `æ–°è¦äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆæ—¥æ™‚å¤‰æ›´ï¼‰\n\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `${name} æ§˜\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
              `ğŸ“… ${newDateTime}\n` +
              `ğŸ’¼ ${booking.course}\n\n` +
              `ğŸ“ ${booking.phone}\n` +
              `ğŸ  ${booking.postalCode}\n${booking.address}\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `â€» å…ƒã®å¸Œæœ›æ—¥æ™‚: ${booking.originalDateTime || 'ä¸æ˜'}`
      },
      {
        type: 'template',
        altText: 'äºˆç´„ã®ç¢ºèª',
        template: {
          type: 'confirm',
          text: `ã“ã®äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã™ã‹ï¼Ÿ`,
          actions: [
            {
              type: 'postback',
              label: 'å—ã‘ä»˜ã‘ã‚‹',
              data: `approve_${requestId}`
            },
            {
              type: 'postback',
              label: 'ãŠæ–­ã‚Šã™ã‚‹',
              data: `reject_${requestId}`
            }
          ]
        }
      }
    ];

    const adminSent = sendLineMessage(CONFIG.ADMIN_USER_ID, adminMessages, adminToken);
    console.log('ç®¡ç†è€…é€šçŸ¥é€ä¿¡çµæœ:', adminSent ? 'æˆåŠŸ' : 'å¤±æ•—');

    logAction('æ—¥æ™‚å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ', userId, `${requestId} â†’ ${newDateTime}`);

    const duration = Date.now() - startTime;
    console.log(`=== æ—¥æ™‚å¤‰æ›´å‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    console.error('handleReschedule error:', error);
    logError('æ—¥æ™‚å¤‰æ›´å‡¦ç†ã‚¨ãƒ©ãƒ¼', error.toString());
    sendLineMessage(userId, [{
      type: 'text',
      text: `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚`
    }]);
  }
}

/**
 * æ—¥æ™‚å¤‰æ›´ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
 */
function handleRescheduleCancel(requestId, userId) {
  try {
    console.log('=== æ—¥æ™‚å¤‰æ›´ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† ===');
    console.log('å—ä»˜ç•ªå·:', requestId);

    const booking = getBooking(requestId);

    if (booking) {
      booking.status = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      booking.cancelledAt = new Date().toISOString();
      booking.updatedAt = new Date().toISOString();
      saveBooking(requestId, booking);
    }

    logAction('æ—¥æ™‚å¤‰æ›´ã‚­ãƒ£ãƒ³ã‚»ãƒ«', userId, requestId);

  } catch (error) {
    console.error('handleRescheduleCancel error:', error);
    logError('æ—¥æ™‚å¤‰æ›´ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

/**
 * æœ€é€Ÿè¿”ä¿¡ç”¨ã®é–¢æ•°
 */
function replyLineMessage(replyToken, messages, token) {
  const url = 'https://api.line.me/v2/bot/message/reply';
  const accessToken = token || CONFIG.LINE_CHANNEL_ACCESS_TOKEN;
  
  UrlFetchApp.fetch(url, {
    'headers': {
      'Content-Type': 'application/json; charset=UTF-8',
      'Authorization': 'Bearer ' + accessToken,
    },
    'method': 'post',
    'payload': JSON.stringify({
      'replyToken': replyToken,
      'messages': messages,
    }),
    'muteHttpExceptions': true
  });
}

/**
 * äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ URLç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµç‰ˆï¼‰
 * ãƒ—ãƒªãƒ•ã‚£ãƒ«: ç®¡ç†ç”¨ID(userId) + éƒµä¾¿ç•ªå·(ã€’)
 */
function buildBookingFormUrl(userId) {
  const formId = CONFIG.FORM.BOOKING.ID;
  const userIdEntry = CONFIG.FORM.BOOKING.USER_ID_ENTRY;
  const postalCodeEntry = CONFIG.FORM.BOOKING.POSTAL_CODE_ENTRY;

  return `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&${userIdEntry}=${encodeURIComponent(userId)}&${postalCodeEntry}=%E3%80%92`;
}

/**
 * äºˆç´„æ‰¿èªå‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµç‰ˆï¼‰
 * æ‰¿èªã¨åŒæ™‚ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ï¼†ç¢ºå®šé€šçŸ¥ã‚’é€ä¿¡
 */
function approveReservation(requestId, adminUserId) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„æ‰¿èªå‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã‚¨ãƒ©ãƒ¼: å—ä»˜ç•ªå· ${requestId} ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`
      }], adminToken);
      return;
    }

    if (booking.status === 'ç¢ºå®š') {
      console.log('ã™ã§ã«ç¢ºå®šæ¸ˆã¿ã§ã™');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã“ã®äºˆç´„ã¯ã™ã§ã«ç¢ºå®šæ¸ˆã¿ã§ã™\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œç¢ºå®šã€ã«æ›´æ–°ï¼ˆæ‰¿èªã¨åŒæ™‚ã«ç¢ºå®šï¼‰
    booking.status = 'ç¢ºå®š';
    booking.approvedDateTime = booking.desiredDateTime;
    booking.approvedAt = new Date().toISOString();
    booking.approvedBy = adminUserId;
    booking.updatedAt = new Date().toISOString();

    const saved = saveBooking(requestId, booking);

    if (!saved) {
      console.error('äºˆç´„æ›´æ–°ã«å¤±æ•—');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    // â˜… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²
    const name = booking.userName || 'ï¼ˆæœªè¨­å®šï¼‰';
    const calendarAdded = addToCalendar(booking.approvedDateTime, booking.course, requestId, name);
    console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²çµæœ:', calendarAdded ? 'æˆåŠŸ' : 'å¤±æ•—');

    // â˜… ãƒ•ã‚©ãƒ¼ãƒ é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆæ–°ãƒ•ãƒ­ãƒ¼ã§ã¯ä¸è¦ãªãŸã‚åœæ­¢ï¼‰
    /*
    try {
      updateFormDateChoices();
    } catch (updateError) {
      console.error('ãƒ•ã‚©ãƒ¼ãƒ é¸æŠè‚¢æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
    }
    */

    console.log('æ‰¿èªãƒ»ç¢ºå®šå‡¦ç†æˆåŠŸ:', requestId);

    // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ç¢ºå®šé€šçŸ¥ï¼ˆPush API - æœ‰æ–™1é€šç›®ï¼‰
    const userMessage = `ã”äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸ\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `ğŸ“… æ—¥æ™‚\n${booking.approvedDateTime}\n\n` +
                       `ğŸ’¼ ã‚³ãƒ¼ã‚¹\n${booking.course}\n\n` +
                       `ğŸ  å½“æ—¥ãŠä¼ºã„ã™ã‚‹ä½æ‰€\n${booking.postalCode}\n${booking.address}\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                       `${name} æ§˜\n\n` +
                       `å½“æ—¥ãŠä¼ºã„ã—ã¾ã™\n\n` +
                       `â€»ã”äºˆç´„å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ã¯\nãŠé›»è©±ã«ã¦ãŠå•ã„åˆã‚ã›ãã ã•ã„`;

    sendLineMessage(booking.userId, [{ type: 'text', text: userMessage }]);

    // â˜… ç®¡ç†è€…ã¸ç¢ºå®šé€šçŸ¥ï¼ˆReply APIã§æ—¢ã«è¿”ä¿¡æ¸ˆã¿ãªã®ã§ã€è©³ç´°ã¯Pushã§é€ä¿¡ï¼‰
    const adminMessage = `âœ… äºˆç´„ç¢ºå®š\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `ğŸ“… æ—¥æ™‚\n${booking.approvedDateTime}\n\n` +
                       `ğŸ’¼ ã‚³ãƒ¼ã‚¹\n${booking.course}\n\n` +
                       `ğŸ‘¤ ãŠåå‰\n${name} æ§˜\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                       `ğŸ“ é›»è©±ç•ªå·\n${booking.phone}\n\n` +
                       `ğŸ  ä½æ‰€\n${booking.postalCode}\n${booking.address}\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `å—ä»˜ç•ªå·: ${requestId}\n` +
                       `ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: ${calendarAdded ? 'âœ“' : 'âœ—'}`;

    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    sendLineMessage(adminUserId, [{ type: 'text', text: adminMessage }], adminToken);

    logAction('äºˆç´„ç¢ºå®š', adminUserId, requestId);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„æ‰¿èªãƒ»ç¢ºå®šå‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`approveReservation error (${duration}ms):`, error);
    logError('äºˆç´„æ‰¿èªã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

/**
 * äºˆç´„ãŠæ–­ã‚Šå‡¦ç†
 */
function rejectReservation(requestId, adminUserId) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„ãŠæ–­ã‚Šå‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã‚¨ãƒ©ãƒ¼: å—ä»˜ç•ªå· ${requestId} ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`
      }], adminToken);
      return;
    }

    if (booking.status === 'ãŠæ–­ã‚Š') {
      console.log('ã™ã§ã«ãŠæ–­ã‚Šæ¸ˆã¿ã§ã™');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã“ã®äºˆç´„ã¯ã™ã§ã«ãŠæ–­ã‚Šæ¸ˆã¿ã§ã™\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    booking.status = 'ãŠæ–­ã‚Š';
    booking.rejectedAt = new Date().toISOString();
    booking.rejectedBy = adminUserId;
    booking.updatedAt = new Date().toISOString();

    const saved = saveBooking(requestId, booking);

    if (!saved) {
      console.error('äºˆç´„æ›´æ–°ã«å¤±æ•—');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    console.log('ãŠæ–­ã‚Šå‡¦ç†æˆåŠŸ:', requestId);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸é€šçŸ¥ï¼ˆç®¡ç†botãƒˆãƒ¼ã‚¯ãƒ³ã§é€ä¿¡ï¼‰
    const userMessage = `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“\n\nä»¥ä¸‹ã®äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãŠå—ã‘ã§ãã¾ã›ã‚“ã§ã—ãŸ\n\nå—ä»˜ç•ªå·\n${requestId}\n\nå¸Œæœ›æ—¥æ™‚\n${booking.desiredDateTime}\n\nã‚³ãƒ¼ã‚¹\n${booking.course}\n\nåˆ¥ã®æ—¥æ™‚ã§ãŠè©¦ã—ãã ã•ã„`;

    sendLineMessage(booking.userId, [{
      type: 'text',
      text: userMessage
    }]);

    // ç®¡ç†è€…ã¸ç¢ºèªé€šçŸ¥
    const adminMessage = `ãŠæ–­ã‚Šå®Œäº†\n\nå—ä»˜ç•ªå·\n${requestId}\n\næ—¥æ™‚\n${booking.desiredDateTime}\n\nã‚³ãƒ¼ã‚¹\n${booking.course}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã—ã¾ã—ãŸ`;

    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    sendLineMessage(adminUserId, [{
      type: 'text',
      text: adminMessage
    }], adminToken);

    logAction('äºˆç´„ãŠæ–­ã‚Š', adminUserId, requestId);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„ãŠæ–­ã‚Šå‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`rejectReservation error (${duration}ms):`, error);
    logError('äºˆç´„ãŠæ–­ã‚Šã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

// ============================================
// Googleãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼ï¼ˆçµ±åˆç‰ˆï¼‰
// ============================================

/**
 * ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ï¼ˆLINEå…ˆè¡Œãƒ•ãƒ­ãƒ¼ç‰ˆï¼‰
 */
function onFormSubmit(e) {
  try {
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ å›ç­”å—ä¿¡ ===');

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã¯ãƒ•ãƒ­ãƒ¼ã®ã€Œæœ€å¾Œã€ã«ãªã£ãŸãŸã‚ã€ã“ã“ã§æ—¢å­˜ã®äºˆç´„ã¨ç´ä»˜ã‘ã‚‹
    handleInitialFormSubmit(e);

  } catch (error) {
    console.error('onFormSubmit error:', error);
    logError('onFormSubmit ã‚¨ãƒ©ãƒ¼', error.toString());

    try {
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(CONFIG.ADMIN_USER_ID, [{
        type: 'text',
        text: `ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼\n\nãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\nã‚¨ãƒ©ãƒ¼: ${error.toString()}\n\nå®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„`
      }], adminToken);
    } catch (notifyError) {
      console.error('ã‚¨ãƒ©ãƒ¼é€šçŸ¥å¤±æ•—:', notifyError);
    }
  }
}

/**
 * äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ï¼ˆLINEå…ˆè¡Œãƒ•ãƒ­ãƒ¼ç‰ˆï¼‰
 * LINEã§æ—¥æ™‚ã¾ã§æ±ºå®šæ¸ˆã¿(FormPending)ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ã«ã€ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®å€‹äººæƒ…å ±ã‚’çµ±åˆã™ã‚‹
 */
function handleInitialFormSubmit(e) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†é–‹å§‹ï¼ˆç´ä»˜ã‘ï¼‰ ===');

    const data = e.namedValues;

    // ãƒ˜ãƒ«ãƒ‘é–¢æ•°
    const getValue = (key, defaultVal = '') => {
      return (data[key] && data[key][0]) ? data[key][0] : defaultVal;
    };

    // ç®¡ç†ç”¨ID(userId)ã¯å¿…é ˆ
    const userId = getValue('ç®¡ç†ç”¨ID(âš ï¸å¤‰æ›´ã‚’åŠ ãˆãªã„ã§ãã ã•ã„)', null);
    
    // å€‹äººæƒ…å ±
    const name = getValue('ãŠåå‰', 'ï¼ˆæœªå…¥åŠ›ï¼‰');
    const phone = getValue('é›»è©±ç•ªå·', 'æœªå…¥åŠ›');
    const postalCode = getValue('éƒµä¾¿ç•ªå·', '');
    const address = getValue('ã”ä½æ‰€', 'æœªå…¥åŠ›');
    
    console.log('å—ä¿¡ãƒ‡ãƒ¼ã‚¿ - userId:', userId);

    if (!userId || !phone || !address) {
      console.error('å¿…é ˆé …ç›®ä¸è¶³ - userId:', userId);
      return;
    }

    // â˜… FormPendingçŠ¶æ…‹ã®äºˆç´„ã‚’æ¤œç´¢
    const booking = findPendingBooking(userId);

    if (!booking) {
      console.error('å…¥åŠ›å¾…ã¡ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', userId);
      // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ã‚‹ï¼ˆæ–°è¦ä½œæˆã›ãšã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ï¼‰
      sendLineMessage(userId, [{
        type: 'text',
        text: 'ã‚¨ãƒ©ãƒ¼ï¼šäºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚\næœ€åˆã‹ã‚‰ã€Œäºˆç´„ã€ã¨å…¥åŠ›ã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚'
      }]);
      return;
    }

    const requestId = booking.requestId;
    console.log('äºˆç´„ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹:', requestId, booking.desiredDateTime);

    // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    booking.userName = name;
    booking.phone = phone;
    booking.postalCode = postalCode;
    booking.address = address;
    booking.status = 'æ‰¿èªå¾…ã¡'; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€²è¡Œ
    booking.updatedAt = new Date().toISOString();

    saveBooking(requestId, booking);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å®Œäº†é€šçŸ¥ï¼ˆPush API - æœ‰æ–™ï¼‰
    const userReceiptMessage = 'ã”äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚\n\n' +
                               'æ‹…å½“è€…ãŒå†…å®¹ã‚’ç¢ºèªå¾Œã€LINEã«ã¦ã€Œäºˆç´„ç¢ºå®šã€ã¾ãŸã¯ã€Œèª¿æ•´ã€ã®ã”é€£çµ¡ã‚’ã„ãŸã—ã¾ã™ã€‚\n' + 
                               'ï¼ˆâ€»ã¾ã äºˆç´„ã¯ç¢ºå®šã—ã¦ãŠã‚Šã¾ã›ã‚“ï¼‰\n\n' +
                               'é€šçŸ¥ãŒå±Šãã¾ã§ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
    
    sendLineMessage(userId, [{ type: 'text', text: userReceiptMessage }]);

    // ç®¡ç†è€…ã¸ã®é€šçŸ¥ï¼ˆPush API - æœ‰æ–™ï¼‰
    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    const adminMessages = [
      {
        type: 'text',
        text: `æ–°è¦äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `${name} æ§˜\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
              `ğŸ“… ${booking.desiredDateTime}\n` +
              `ğŸ’¼ ${booking.course}\n\n` +
              `ğŸ“ ${phone}\n` +
              `ğŸ  ${postalCode}\n${address}\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
      },
      {
        type: 'template',
        altText: 'äºˆç´„ã®ç¢ºèª',
        template: {
          type: 'confirm',
          text: `ã“ã®äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã™ã‹ï¼Ÿ`,
          actions: [
            {
              type: 'postback',
              label: 'å—ã‘ä»˜ã‘ã‚‹',
              data: `approve_${requestId}`
            },
            {
              type: 'postback',
              label: 'ãŠæ–­ã‚Šã™ã‚‹',
              data: `reject_${requestId}`
            }
          ]
        }
      }
    ];

    sendLineMessage(CONFIG.ADMIN_USER_ID, adminMessages, adminToken);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„ç´ä»˜ã‘ãƒ»ç”³è«‹å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    console.error(`handleInitialFormSubmit error:`, error);
    logError('äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

// -------------------------------------------------------------
//  LINEå…ˆè¡Œãƒ•ãƒ­ãƒ¼ç”¨ã®é–¢æ•°ï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹å¯¾å¿œï¼‰
// -------------------------------------------------------------

/**
 * ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆ
 */
function generateRequestId() {
  return Utilities.getUuid().slice(0, 8).toUpperCase();
}

/**
 * äºˆç´„ãƒ•ãƒ­ãƒ¼é–‹å§‹ (ãƒˆãƒªã‚¬ãƒ¼: ã€Œäºˆç´„ã€)
 * 1. ã‚³ãƒ¼ã‚¹é¸æŠã‚’æç¤º (Button Template - Reply API)
 * â€» ã€Œäºˆç´„ã€ã¨æ‰“ãŸã‚ŒãŸã‚‰ã€éå»ã®FormPendingãªäºˆç´„ãŒã‚ã‚Œã°ç„¡åŠ¹åŒ–ã™ã‚‹ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
 */
function startReservationFlow(userId, replyToken) {
  // æ—¢å­˜ã®å…¥åŠ›å¾…ã¡äºˆç´„ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰±ã„ã«æ›´æ–°ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
  const pendingBooking = findPendingBooking(userId);
  if (pendingBooking) {
    pendingBooking.status = 'Reset';
    pendingBooking.updatedAt = new Date().toISOString();
    saveBooking(pendingBooking.requestId, pendingBooking);
  }

  const requestId = generateRequestId();
  const booking = {
    requestId: requestId,
    userId: userId,
    status: 'CoursePending',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  saveBooking(requestId, booking);

  // ã‚³ãƒ¼ã‚¹é¸æŠã¸
  showCourseSelection(requestId, userId, replyToken);
}

/**
 * ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢è¡¨ç¤º
 */
function showCourseSelection(requestId, userId, replyToken) {
  const courseNames = Object.keys(CONFIG.COURSES);
  
  const actions = courseNames.map(name => {
    const course = CONFIG.COURSES[name];
    return {
      type: 'postback',
      label: `${name} (${course.price}å††)`,
      data: `select_course_${requestId}_${name}`
    };
  });

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
  actions.push({
    type: 'postback',
    label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    data: `cancel_flow_${requestId}`
  });

  const message = {
    type: 'template',
    altText: 'ã‚³ãƒ¼ã‚¹é¸æŠ',
    template: {
      type: 'buttons',
      text: 'ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„',
      actions: actions
    }
  };

  if (replyToken) {
    replyLineMessage(replyToken, [message]);
  } else {
    // äºˆå‚™
    sendLineMessage(userId, [message]);
  }
  logAction('ã‚³ãƒ¼ã‚¹é¸æŠæç¤º', userId, requestId);
}

/**
 * ã‚³ãƒ¼ã‚¹é¸æŠå¾Œã®å‡¦ç†ï¼ˆæ—¥ä»˜é¸æŠã¸ï¼‰
 */
function handleCourseSelection(replyToken, requestId, courseName, userId) {
  try {
    const booking = getBooking(requestId);
    if (!booking) {
      replyLineMessage(replyToken, [{ type: 'text', text: 'ã‚¨ãƒ©ãƒ¼ï¼šäºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' }]);
      return;
    }

    booking.course = courseName;
    booking.status = 'DatePending';
    booking.updatedAt = new Date().toISOString();
    saveBooking(requestId, booking);

    // æ—¥ä»˜é¸æŠç”»é¢ã‚’è¡¨ç¤º (offset 0)
    showDateSelection(requestId, 0, replyToken, userId);

  } catch (error) {
    console.error('handleCourseSelection error:', error);
    replyLineMessage(replyToken, [{ type: 'text', text: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' }]);
  }
}

/**
 * æ—¥ä»˜é¸æŠç”»é¢è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
 */
function showDateSelection(requestId, offset, replyToken, userId) {
  try {
    const availableDates = getAvailableDates(14); // 2é€±é–“åˆ†

    if (availableDates.length === 0) {
      const msg = { type: 'text', text: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nç¾åœ¨ã€äºˆç´„å¯èƒ½ãªæ—¥ç¨‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚' };
      if (replyToken) replyLineMessage(replyToken, [msg]);
      else sendLineMessage(userId, [msg]);
      return;
    }

    const start = offset;
    const end = offset + 11; // 11æ  + æ¬¡ã¸ + æˆ»ã‚‹(è¨ˆ13)
    const pagedDates = availableDates.slice(start, end);
    const hasNext = availableDates.length > end;

    const quickReplyItems = pagedDates.map(dateStr => ({
      type: 'action',
      action: {
        type: 'postback',
        label: dateStr,
        data: `select_date_${requestId}_${dateStr}`
      }
    }));

     if (hasNext) {
      quickReplyItems.push({
        type: 'action',
        action: {
          type: 'postback',
          label: 'æ¬¡ã¸',
          data: `next_dates_${requestId}_${end}`
        }
      });
    }

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    // offset > 0 ãªã‚‰ã€Œå‰ã®ãƒšãƒ¼ã‚¸(offset-12)ã€ã¸
    // offset === 0 ãªã‚‰ã€Œã‚³ãƒ¼ã‚¹é¸æŠã€ã¸
    if (quickReplyItems.length < 13) {
       if (offset > 0) {
         const prevOffset = Math.max(0, offset - 12);
         quickReplyItems.push({
          type: 'action',
          action: {
            type: 'postback',
            label: 'å‰ã®ãƒšãƒ¼ã‚¸', // å‰ã®ãƒšãƒ¼ã‚¸ã¸
            data: `next_dates_${requestId}_${prevOffset}`
          }
        });
       } else {
         quickReplyItems.push({
          type: 'action',
          action: {
            type: 'postback',
            label: 'æˆ»ã‚‹', // ã‚³ãƒ¼ã‚¹é¸æŠã¸
            data: `back_to_course_${requestId}`
          }
        });
       }
    }

    const message = {
      type: 'text',
      text: `ã”å¸Œæœ›ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`,
      quickReply: {
        items: quickReplyItems
      }
    };

    if (replyToken) {
       replyLineMessage(replyToken, [message]);
    } else {
       sendLineMessage(userId, [message]);
    }
    logAction('æ—¥ä»˜é¸æŠæç¤º', userId, `${requestId} - offset:${offset}`);

  } catch (error) {
    console.error('showDateSelection error:', error);
  }
}

/**
 * æ—¥ä»˜é¸æŠå¾Œã®å‡¦ç†ï¼ˆæ™‚é–“é¸æŠã¸ï¼‰
 */
function handleDateSelection(replyToken, requestId, dateStr, userId) {
  try {
    const booking = getBooking(requestId);
    if (!booking) {
      replyLineMessage(replyToken, [{ type: 'text', text: 'ã‚¨ãƒ©ãƒ¼ï¼šäºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' }]);
      return;
    }

    booking.tempDateStr = dateStr;
    saveBooking(requestId, booking);

    // æ™‚é–“é¸æŠç”»é¢ã‚’è¡¨ç¤º (offset 0)
    showTimeSelection(requestId, dateStr, 0, replyToken, userId);

  } catch (error) {
    console.error('handleDateSelection error:', error);
    replyLineMessage(replyToken, [{ type: 'text', text: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' }]);
  }
}

/**
 * æ™‚é–“é¸æŠç”»é¢è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
 */
function showTimeSelection(requestId, dateStr, offset, replyToken, userId) {
  try {
    const booking = getBooking(requestId);
    const availableTimes = getAvailableTimesForDate(dateStr, booking.course);

    if (availableTimes.length === 0) {
       const msg = { type: 'text', text: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\né¸æŠã•ã‚ŒãŸæ—¥ã¯æº€å¸­ãªã©ã§äºˆç´„ã§ãã¾ã›ã‚“ã€‚\n\næã‚Œå…¥ã‚Šã¾ã™ãŒã€ä»–ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚' };
       if(replyToken) replyLineMessage(replyToken, [msg]);
       else sendLineMessage(userId, [msg]);
       return;
    }

    const start = offset;
    const end = offset + 11; // 11æ  + æ¬¡ã¸ + æˆ»ã‚‹
    const pagedTimes = availableTimes.slice(start, end);
    const hasNext = availableTimes.length > end;

     const quickReplyItems = pagedTimes.map(timeStr => ({
      type: 'action',
      action: {
        type: 'postback',
        label: timeStr,
        data: `select_time_${requestId}_${timeStr}`
      }
    }));

    if (hasNext) {
      quickReplyItems.push({
        type: 'action',
        action: {
          type: 'postback',
          label: 'æ¬¡ã¸',
          data: `next_times_${requestId}_${end}`
        }
      });
    } 
    
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    // offset > 0 ãªã‚‰ã€Œå‰ã®ãƒšãƒ¼ã‚¸ã€
    // offset === 0 ãªã‚‰ã€Œæ—¥ä»˜é¸æŠã€ã¸
    if (quickReplyItems.length < 13) {
        if (offset > 0) {
          const prevOffset = Math.max(0, offset - 12);
          quickReplyItems.push({
            type: 'action',
            action: {
              type: 'postback',
              label: 'å‰ã®ãƒšãƒ¼ã‚¸',
              data: `next_times_${requestId}_${prevOffset}`
            }
          });
        } else {
          quickReplyItems.push({
            type: 'action',
            action: {
              type: 'postback',
              label: 'æˆ»ã‚‹',
              data: `back_to_date_${requestId}`
            }
          });
        }
    }

    const message = {
      type: 'text',
      text: `${dateStr} ã®å¸Œæœ›æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`,
      quickReply: {
        items: quickReplyItems
      }
    };

    if (replyToken) replyLineMessage(replyToken, [message]);
    else sendLineMessage(userId, [message]);

    logAction('æ™‚é–“é¸æŠæç¤º', userId, `${requestId} - ${dateStr} offset:${offset}`);

  } catch (error) {
     console.error('showTimeSelection error:', error);
  }
}

/**
 * æ™‚é–“é¸æŠå¾Œã®å‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ èª˜å°ï¼‰
 */
function handleTimeSelection(requestId, timeStr, userId, replyToken) {
  try {
    const booking = getBooking(requestId);
     if (!booking) {
      const msg = { type: 'text', text: 'ã‚¨ãƒ©ãƒ¼ï¼šäºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' };
      if (replyToken) replyLineMessage(replyToken, [msg]);
      else sendLineMessage(userId, [msg]);
      return;
    }

    const dateStr = booking.tempDateStr;
    if (!dateStr) {
       const msg = { type: 'text', text: 'ã‚¨ãƒ©ãƒ¼ï¼šæ—¥ä»˜ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚' };
       if (replyToken) replyLineMessage(replyToken, [msg]);
       else sendLineMessage(userId, [msg]);
       return;
    }

    // æ—¥æ™‚ã‚’çµåˆã—ã¦ãƒ‘ãƒ¼ã‚¹
    const dateMatch = dateStr.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
    const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})/);

    let desiredDateTime = null;
    let reservationDate = null;

    if (dateMatch && timeMatch) {
       const year = parseInt(dateMatch[1]);
       const month = parseInt(dateMatch[2]);
       const day = parseInt(dateMatch[3]);
       const hours = parseInt(timeMatch[1]);
       const minutes = parseInt(timeMatch[2]);
       
       reservationDate = new Date(year, month - 1, day, hours, minutes);
       desiredDateTime = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')} ${timeStr}`;
    } else {
       const msg = { type: 'text', text: 'ã‚¨ãƒ©ãƒ¼ï¼šæ—¥æ™‚ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚' };
       if (replyToken) replyLineMessage(replyToken, [msg]);
       else sendLineMessage(userId, [msg]);
       return;
    }

    // æœ€çµ‚ãƒã‚§ãƒƒã‚¯
    const availability = checkCalendarFast(reservationDate, booking.course);
    if (!availability.available) {
        const msg = { type: 'text', text: `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nã‚¿ãƒƒãƒã®å·®ã§äºˆç´„ãŒåŸ‹ã¾ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚\n\nç†ç”±: ${availability.reason}\n\næã‚Œå…¥ã‚Šã¾ã™ãŒã€å†åº¦æ—¥ä»˜é¸æŠã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚` };
        if (replyToken) replyLineMessage(replyToken, [msg]);
        else sendLineMessage(userId, [msg]);
        return;
    }

    // äºˆç´„æ—¥æ™‚ã‚’ä¿å­˜ã—ã€ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¾…ã¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¸
    booking.desiredDateTime = desiredDateTime;
    booking.status = 'FormPending'; // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¾…ã¡
    booking.updatedAt = new Date().toISOString();
    saveBooking(requestId, booking);

    // ãƒ•ã‚©ãƒ¼ãƒ URLã‚’ç”Ÿæˆï¼ˆå€‹äººæƒ…å ±ã®ã¿å…¥åŠ›ï¼‰
    const formUrl = buildBookingFormUrl(userId);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ¡ˆå†…ï¼ˆReply API - ç„¡æ–™ï¼‰
    const formMessage = {
      type: 'template',
      altText: 'äºˆç´„æƒ…å ±ã®å…¥åŠ›',
      template: {
        type: 'buttons',
        text: `ã€ã“ã®æ™‚é–“ã‚’ä¸€æ™‚çš„ã«ç¢ºä¿ã—ã¦ã„ã¾ã™ã€‘\n${desiredDateTime}\n\nä»–ã®ãŠå®¢æ§˜ãŒäºˆç´„ã§ããªã„ã‚ˆã†ã€æ ã‚’ä»®æŠ¼ã•ãˆã—ã¾ã—ãŸã€‚\n30åˆ†ä»¥å†…ã«ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰äºˆç´„ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚`,
        actions: [
          {
            type: 'uri',
            label: 'æƒ…å ±ã‚’å…¥åŠ›ã—ã¦å®Œäº†',
            uri: formUrl
          },
          {
            type: 'postback',
            label: 'ä»®æŠ¼ã•ãˆã‚’ã‚„ã‚ã‚‹', // ä»®æŠ¼ã•ãˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦æœ€åˆã«æˆ»ã‚‹
            data: `cancel_hold_${requestId}`
          }
        ]
      }
    };
    
    // ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã«ã‚‚ã€Œä»®æŠ¼ã•ãˆã‚’ã‚„ã‚ã‚‹ã€ã‚’å…¥ã‚Œã¦ãŠãï¼ˆå¿µã®ãŸã‚ï¼‰
    const cancelQuickReply = {
      items: [
        {
          type: 'action',
          action: {
            type: 'postback',
            label: 'ä»®æŠ¼ã•ãˆã‚’ã‚„ã‚ã‚‹',
            data: `cancel_hold_${requestId}`
          }
        }
      ]
    };
    
    // Button Templateã«QuickReplyã‚’ä»˜ä¸ã§ãã‚‹ã‹ç¢ºèªï¼šå¯èƒ½
    formMessage.quickReply = cancelQuickReply;

    if (replyToken) replyLineMessage(replyToken, [formMessage]);
    else sendLineMessage(userId, [formMessage]);
    
    logAction('ãƒ•ã‚©ãƒ¼ãƒ èª˜å°', userId, `${requestId} - ${desiredDateTime}`);

  } catch (error) {
    console.error('handleTimeSelection error:', error);
    const msg = { type: 'text', text: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' };
    if (replyToken) replyLineMessage(replyToken, [msg]);
    else sendLineMessage(userId, [msg]);
  }
}

/**
 * ç°¡æ˜“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆç¢ºå®šå‰ã®æœ€çµ‚ç¢ºèªç”¨ï¼‰
 */
function checkCalendarFast(targetDate, course) {
  try {
     // ä»®æŠ¼ã•ãˆãƒã‚§ãƒƒã‚¯ç”¨
     const dateStr = `${targetDate.getFullYear()}-${targetDate.getMonth()+1}-${targetDate.getDate()}`;
     const availableTimes = getAvailableTimesForDate(dateStr, course);

     const hours = String(targetDate.getHours()).padStart(2, '0');
     const minutes = String(targetDate.getMinutes()).padStart(2, '0');
     const timeStr = `${hours}:${minutes}`;

     if (availableTimes.includes(timeStr)) {
       return { available: true };
     } else {
       return { available: false, reason: 'ä»–ã®ãŠå®¢æ§˜ãŒä»®æŠ¼ã•ãˆä¸­ã‹ã€äºˆç´„æ¸ˆã¿ã§ã™' };
     }

  } catch (e) {
    console.error('checkCalendarFast error:', e);
    return { available: false, reason: 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼' };
  }
}

/**
 * ä»®æŠ¼ã•ãˆã‚­ãƒ£ãƒ³ã‚»ãƒ«
 */
function handleCancelHold(requestId, userId, replyToken) {
  try {
    const booking = getBooking(requestId);
    if(booking) {
      booking.status = 'Cancelled';
      saveBooking(requestId, booking);
    }
    
    // æœ€åˆã«æˆ»ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const msg = {
      type: 'text',
      text: 'ä»®æŠ¼ã•ãˆã‚’è§£é™¤ã—ã¾ã—ãŸã€‚\næœ€åˆã‹ã‚‰äºˆç´„ã‚’ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ',
      quickReply: {
        items: [
          {
            type: 'action',
            action: {
              type: 'message',
              label: 'äºˆç´„ã‚’ã‚„ã‚Šç›´ã™',
              text: 'äºˆç´„'
            }
          }
        ]
      }
    };
    
    if (replyToken) replyLineMessage(replyToken, [msg]);
    else sendLineMessage(userId, [msg]);
    
  } catch(e) {
    console.error('handleCancelHold error:', e);
  }
}

// handleApprovedFormSubmit ã¯å»ƒæ­¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµã®ãŸã‚ï¼‰

/**
 * ãƒˆãƒªã‚¬ãƒ¼è¨­å®šç”¨é–¢æ•°ï¼ˆæ‰‹å‹•å®Ÿè¡Œç”¨ï¼‰
 * 1æ™‚é–“ã”ã¨ã«ãƒ•ã‚©ãƒ¼ãƒ ã®é¸æŠè‚¢ã‚’æ›´æ–°ã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
 */
function setupTriggers() {
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'updateFormDateChoices') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // æ–°ã—ã„ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆï¼ˆ1æ™‚é–“ã”ã¨ï¼‰
  ScriptApp.newTrigger('updateFormDateChoices')
    .timeBased()
    .everyHours(1)
    .create();

  console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ é¸æŠè‚¢æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆ1æ™‚é–“ã”ã¨ï¼‰');
}
