// ============================================
// ãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ« - main.gs
// ============================================

/**
 * GETãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»Webhookæ¤œè¨¼ç”¨ï¼‰
 */
function doGet(e) {
  console.log('=== doGetå—ä¿¡ ===');
  return ContentService.createTextOutput(JSON.stringify({ 
    status: 'ok', 
    message: 'LINE Bot is running',
    timestamp: new Date().toISOString()
  })).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Webhookå—ä¿¡å‡¦ç†ï¼ˆLINE Messaging APIï¼‰
 */
function doPost(e) {
  const startTime = Date.now();

  try {
    console.log('=== Webhookå—ä¿¡ ===');

    if (!e || !e.postData || !e.postData.contents) {
      console.error('Invalid request: no postData');
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Invalid request' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const data = JSON.parse(e.postData.contents);

    if (!data.events || !Array.isArray(data.events)) {
      console.error('Invalid request: no events array');
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No events' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    console.log('å—ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°:', data.events.length);

    data.events.forEach((event, index) => {
      try {
        console.log(`\nã‚¤ãƒ™ãƒ³ãƒˆ${index + 1}/${data.events.length}ã‚’å‡¦ç†ä¸­...`);
        handleEvent(event);
      } catch (eventError) {
        console.error(`ã‚¤ãƒ™ãƒ³ãƒˆ${index + 1}ã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, eventError);
        logError('ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼', eventError.toString());
      }
    });

    const duration = Date.now() - startTime;
    console.log(`\n=== Webhookå‡¦ç†å®Œäº† (${duration}ms) ===`);

    return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`doPost error (${duration}ms):`, error);
    logError('doPost error', error.toString());

    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */
function handleEvent(event) {
  console.log('ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—:', event.type);

  if (event.source && event.source.userId) {
    console.log('â˜…â˜…â˜… å—ä¿¡ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', event.source.userId, 'â˜…â˜…â˜…');
  }

  if (event.type === 'message' && event.message.type === 'text') {
    handleTextMessage(event);
  } else if (event.type === 'postback') {
    handlePostback(event);
  } else {
    console.log('æœªå¯¾å¿œã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—:', event.type);
  }
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ï¼ˆReply APIä½¿ç”¨ãƒ»ç„¡æ–™ï¼‰
 */
function handleTextMessage(event) {
  const userId = event.source.userId;
  const text = event.message.text.trim();
  const replyToken = event.replyToken;

  console.log('ãƒ†ã‚­ã‚¹ãƒˆå—ä¿¡:', text);

  // replyTokenãŒãªã„å ´åˆã¯å‡¦ç†ã—ãªã„
  if (!replyToken) {
    console.error('replyTokenãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  let replyMessages = [];

  // IDç¢ºèªã‚³ãƒãƒ³ãƒ‰
  if (text === 'ID' || text === 'id' || text === 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID' || text === 'ãƒã‚¤ID') {
    replyMessages = [{
      type: 'text',
      text: `ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:\n${userId}`
    }];
    logAction('IDç¢ºèª', userId, userId);
  }

  // äºˆç´„é–‹å§‹
  else if ((text.includes('äºˆç´„') || text.includes('ã‚ˆã‚„ã')) && !text.includes('ç¢ºèª') && !text.includes('ä¸€è¦§')) {
    replyMessages = [{
      type: 'template',
      altText: 'äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ',
      template: {
        type: 'buttons',
        text: 'ä¸‹è¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦ãã ã•ã„\n\nâ€»é€ä¿¡å¾Œã€æ‰¿èªã•ã‚Œã‚‹ã¨LINEã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™',
        actions: [
          {
            type: 'uri',
            label: 'äºˆç´„ã™ã‚‹',
            uri: buildBookingFormUrl(userId)
          }
        ]
      }
    }];
    logAction('äºˆç´„é–‹å§‹', userId, '');
  }
  // äºˆç´„ç¢ºèª
  else if (text === 'äºˆç´„ç¢ºèª' || text === 'äºˆç´„ä¸€è¦§') {
    // äºˆç´„ä¸€è¦§ã¯Reply APIã§è¿”ã™
    const bookings = getUserBookings(userId);
    
    if (!bookings || bookings.length === 0) {
      replyMessages = [{
        type: 'text',
        text: 'ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'
      }];
    } else {
      let message = 'ã€äºˆç´„ä¸€è¦§ã€‘\n';
      bookings.slice(0, 3).forEach((booking, index) => {
        message += `\n${index + 1}. ${booking.desiredDateTime}\n   ${booking.course} - ${booking.status}`;
      });
      if (bookings.length > 3) {
        message += `\n\nä»–${bookings.length - 3}ä»¶`;
      }
      replyMessages = [{ type: 'text', text: message }];
    }
    logAction('äºˆç´„ç¢ºèª', userId, `${bookings.length}ä»¶`);
  }

  // ãã®ä»– - å¿œç­”ã—ãªã„ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¯€ç´„ï¼‰
  else {
    console.log('æœªå¯¾å¿œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ - å¿œç­”ã‚¹ã‚­ãƒƒãƒ—:', text);
    return; // å¿œç­”ã—ãªã„ = ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¶ˆè²»ãªã—
  }

  // Reply APIã§è¿”ä¿¡ï¼ˆç„¡æ–™ï¼‰
  replyLineMessage(replyToken, replyMessages, CONFIG.LINE_CHANNEL_ACCESS_TOKEN);
}

/**
 * äºˆç´„ä¸€è¦§è¡¨ç¤º
 */
function showUserBookings(userId) {
  try {
    const bookings = getUserBookings(userId);

    if (!bookings || bookings.length === 0) {
      sendLineMessage(userId, [{
        type: 'text',
        text: 'ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\næ–°è¦äºˆç´„ã¯ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã‹ã‚‰è¡Œãˆã¾ã™ã€‚'
      }]);
      return;
    }

    let message = 'ã€ã‚ãªãŸã®äºˆç´„ä¸€è¦§ã€‘\n\n';

    bookings.forEach((booking, index) => {
      message += `${index + 1}. å—ä»˜ç•ªå·: ${booking.requestId}\n`;
      message += `   æ—¥æ™‚: ${booking.desiredDateTime}\n`;
      message += `   ã‚³ãƒ¼ã‚¹: ${booking.course}\n`;
      message += `   çŠ¶æ…‹: ${booking.status}\n`;

      if (booking.status === 'æ‰¿èªæ¸ˆã¿' && booking.approvedDateTime) {
        message += `   ç¢ºå®šæ—¥æ™‚: ${booking.approvedDateTime}\n`;
      }

      message += '\n';
    });

    sendLineMessage(userId, [{
      type: 'text',
      text: message
    }]);

    logAction('äºˆç´„ä¸€è¦§è¡¨ç¤º', userId, `${bookings.length}ä»¶`);

  } catch (error) {
    console.error('showUserBookings error:', error);
    sendLineMessage(userId, [{
      type: 'text',
      text: 'äºˆç´„ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
    }]);
  }
}

/**
 * ãƒã‚¹ãƒˆãƒãƒƒã‚¯å‡¦ç†ï¼ˆæœ€é€Ÿè¿”ä¿¡å¯¾å¿œï¼‰
 */
function handlePostback(event) {
  const userId = event.source.userId;
  const data = event.postback.data;
  const replyToken = event.replyToken;

  console.log('=== ãƒã‚¹ãƒˆãƒãƒƒã‚¯å‡¦ç†é–‹å§‹ ===');
  logAction('ãƒã‚¹ãƒˆãƒãƒƒã‚¯å—ä¿¡', userId, data);

  if (!data) return;

  const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;

  // æ‰¿èªå‡¦ç†ï¼ˆç®¡ç†è€…ï¼‰
  if (data.startsWith('approve_')) {
    const requestId = data.replace('approve_', '');

    // â˜…æœ€é€Ÿè¿”ä¿¡
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `å‡¦ç†ä¸­...`
    }], adminToken);

    approveReservation(requestId, userId);
  }
  // ãŠæ–­ã‚Šå‡¦ç†ï¼ˆç®¡ç†è€…ï¼‰
  else if (data.startsWith('reject_')) {
    const requestId = data.replace('reject_', '');

    // â˜…æœ€é€Ÿè¿”ä¿¡
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `å‡¦ç†ä¸­...`
    }], adminToken);

    rejectReservation(requestId, userId);
  }
  // æ—¥ä»˜é¸æŠå‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
  else if (data.startsWith('select_date_')) {
    // select_date_{requestId}_{date}
    const parts = data.replace('select_date_', '').split('_');
    const requestId = parts[0];
    const selectedDate = parts.slice(1).join('_'); // æ—¥ä»˜å½¢å¼ã‚’å¾©å…ƒ

    handleDateSelection(requestId, selectedDate, userId, replyToken);
  }
  // æ™‚é–“é¸æŠå‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
  else if (data.startsWith('select_time_')) {
    // select_time_{requestId}_{date}_{time}
    const parts = data.replace('select_time_', '').split('_');
    const requestId = parts[0];
    const selectedDate = parts.slice(1, -1).join('_'); // æ—¥ä»˜éƒ¨åˆ†
    const selectedTime = parts[parts.length - 1]; // æ™‚é–“éƒ¨åˆ†

    handleTimeSelection(requestId, selectedDate, selectedTime, userId, replyToken);
  }
}

/**
 * æœ€é€Ÿè¿”ä¿¡ç”¨ã®é–¢æ•°
 */
function replyLineMessage(replyToken, messages, token) {
  const url = 'https://api.line.me/v2/bot/message/reply';
  const accessToken = token || CONFIG.LINE_CHANNEL_ACCESS_TOKEN;
  
  UrlFetchApp.fetch(url, {
    'headers': {
      'Content-Type': 'application/json; charset=UTF-8',
      'Authorization': 'Bearer ' + accessToken,
    },
    'method': 'post',
    'payload': JSON.stringify({
      'replyToken': replyToken,
      'messages': messages,
    }),
    'muteHttpExceptions': true
  });
}

/**
 * äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ URLç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµç‰ˆï¼‰
 * ãƒ—ãƒªãƒ•ã‚£ãƒ«: ç®¡ç†ç”¨ID(userId) + éƒµä¾¿ç•ªå·(ã€’)
 */
function buildBookingFormUrl(userId) {
  const formId = CONFIG.FORM.BOOKING.ID;
  const userIdEntry = CONFIG.FORM.BOOKING.USER_ID_ENTRY;
  const postalCodeEntry = CONFIG.FORM.BOOKING.POSTAL_CODE_ENTRY;

  return `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&${userIdEntry}=${encodeURIComponent(userId)}&${postalCodeEntry}=%E3%80%92`;
}

/**
 * äºˆç´„æ‰¿èªå‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµç‰ˆï¼‰
 * æ‰¿èªã¨åŒæ™‚ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ï¼†ç¢ºå®šé€šçŸ¥ã‚’é€ä¿¡
 */
function approveReservation(requestId, adminUserId) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„æ‰¿èªå‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã‚¨ãƒ©ãƒ¼: å—ä»˜ç•ªå· ${requestId} ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`
      }], adminToken);
      return;
    }

    if (booking.status === 'ç¢ºå®š') {
      console.log('ã™ã§ã«ç¢ºå®šæ¸ˆã¿ã§ã™');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã“ã®äºˆç´„ã¯ã™ã§ã«ç¢ºå®šæ¸ˆã¿ã§ã™\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œç¢ºå®šã€ã«æ›´æ–°ï¼ˆæ‰¿èªã¨åŒæ™‚ã«ç¢ºå®šï¼‰
    booking.status = 'ç¢ºå®š';
    booking.approvedDateTime = booking.desiredDateTime;
    booking.approvedAt = new Date().toISOString();
    booking.approvedBy = adminUserId;
    booking.updatedAt = new Date().toISOString();

    const saved = saveBooking(requestId, booking);

    if (!saved) {
      console.error('äºˆç´„æ›´æ–°ã«å¤±æ•—');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    // â˜… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²
    const name = booking.userName || 'ï¼ˆæœªè¨­å®šï¼‰';
    const calendarAdded = addToCalendar(booking.approvedDateTime, booking.course, requestId, name);
    console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²çµæœ:', calendarAdded ? 'æˆåŠŸ' : 'å¤±æ•—');

    // â˜… ãƒ•ã‚©ãƒ¼ãƒ é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆç©ºãæ™‚é–“ã‹ã‚‰å‰Šé™¤ï¼‰
    try {
      updateFormDateChoices();
    } catch (updateError) {
      console.error('ãƒ•ã‚©ãƒ¼ãƒ é¸æŠè‚¢æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
    }

    console.log('æ‰¿èªãƒ»ç¢ºå®šå‡¦ç†æˆåŠŸ:', requestId);

    // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ç¢ºå®šé€šçŸ¥ï¼ˆPush API - æœ‰æ–™1é€šç›®ï¼‰
    const userMessage = `ã”äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸ\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `ğŸ“… æ—¥æ™‚\n${booking.approvedDateTime}\n\n` +
                       `ğŸ’¼ ã‚³ãƒ¼ã‚¹\n${booking.course}\n\n` +
                       `ğŸ  å½“æ—¥ãŠä¼ºã„ã™ã‚‹ä½æ‰€\n${booking.postalCode}\n${booking.address}\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                       `${name} æ§˜\n\n` +
                       `å½“æ—¥ãŠä¼ºã„ã—ã¾ã™\n\n` +
                       `â€»ã”äºˆç´„å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ã¯\nãŠé›»è©±ã«ã¦ãŠå•ã„åˆã‚ã›ãã ã•ã„`;

    sendLineMessage(booking.userId, [{ type: 'text', text: userMessage }]);

    // â˜… ç®¡ç†è€…ã¸ç¢ºå®šé€šçŸ¥ï¼ˆReply APIã§æ—¢ã«è¿”ä¿¡æ¸ˆã¿ãªã®ã§ã€è©³ç´°ã¯Pushã§é€ä¿¡ï¼‰
    const adminMessage = `âœ… äºˆç´„ç¢ºå®š\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `ğŸ“… æ—¥æ™‚\n${booking.approvedDateTime}\n\n` +
                       `ğŸ’¼ ã‚³ãƒ¼ã‚¹\n${booking.course}\n\n` +
                       `ğŸ‘¤ ãŠåå‰\n${name} æ§˜\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                       `ğŸ“ é›»è©±ç•ªå·\n${booking.phone}\n\n` +
                       `ğŸ  ä½æ‰€\n${booking.postalCode}\n${booking.address}\n\n` +
                       `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                       `å—ä»˜ç•ªå·: ${requestId}\n` +
                       `ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: ${calendarAdded ? 'âœ“' : 'âœ—'}`;

    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    sendLineMessage(adminUserId, [{ type: 'text', text: adminMessage }], adminToken);

    logAction('äºˆç´„ç¢ºå®š', adminUserId, requestId);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„æ‰¿èªãƒ»ç¢ºå®šå‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`approveReservation error (${duration}ms):`, error);
    logError('äºˆç´„æ‰¿èªã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

/**
 * äºˆç´„ãŠæ–­ã‚Šå‡¦ç†
 */
function rejectReservation(requestId, adminUserId) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„ãŠæ–­ã‚Šå‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã‚¨ãƒ©ãƒ¼: å—ä»˜ç•ªå· ${requestId} ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`
      }], adminToken);
      return;
    }

    if (booking.status === 'ãŠæ–­ã‚Š') {
      console.log('ã™ã§ã«ãŠæ–­ã‚Šæ¸ˆã¿ã§ã™');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `ã“ã®äºˆç´„ã¯ã™ã§ã«ãŠæ–­ã‚Šæ¸ˆã¿ã§ã™\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    booking.status = 'ãŠæ–­ã‚Š';
    booking.rejectedAt = new Date().toISOString();
    booking.rejectedBy = adminUserId;
    booking.updatedAt = new Date().toISOString();

    const saved = saveBooking(requestId, booking);

    if (!saved) {
      console.error('äºˆç´„æ›´æ–°ã«å¤±æ•—');
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(adminUserId, [{
        type: 'text',
        text: `äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nå—ä»˜ç•ªå·: ${requestId}`
      }], adminToken);
      return;
    }

    console.log('ãŠæ–­ã‚Šå‡¦ç†æˆåŠŸ:', requestId);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸é€šçŸ¥ï¼ˆç®¡ç†botãƒˆãƒ¼ã‚¯ãƒ³ã§é€ä¿¡ï¼‰
    const userMessage = `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“\n\nä»¥ä¸‹ã®äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãŠå—ã‘ã§ãã¾ã›ã‚“ã§ã—ãŸ\n\nå—ä»˜ç•ªå·\n${requestId}\n\nå¸Œæœ›æ—¥æ™‚\n${booking.desiredDateTime}\n\nã‚³ãƒ¼ã‚¹\n${booking.course}\n\nåˆ¥ã®æ—¥æ™‚ã§ãŠè©¦ã—ãã ã•ã„`;

    sendLineMessage(booking.userId, [{
      type: 'text',
      text: userMessage
    }]);

    // ç®¡ç†è€…ã¸ç¢ºèªé€šçŸ¥
    const adminMessage = `ãŠæ–­ã‚Šå®Œäº†\n\nå—ä»˜ç•ªå·\n${requestId}\n\næ—¥æ™‚\n${booking.desiredDateTime}\n\nã‚³ãƒ¼ã‚¹\n${booking.course}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã—ã¾ã—ãŸ`;

    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
    sendLineMessage(adminUserId, [{
      type: 'text',
      text: adminMessage
    }], adminToken);

    logAction('äºˆç´„ãŠæ–­ã‚Š', adminUserId, requestId);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„ãŠæ–­ã‚Šå‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`rejectReservation error (${duration}ms):`, error);
    logError('äºˆç´„ãŠæ–­ã‚Šã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

// ============================================
// Googleãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼ï¼ˆçµ±åˆç‰ˆï¼‰
// ============================================

/**
 * ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµç‰ˆï¼‰
 */
function onFormSubmit(e) {
  try {
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ å›ç­”å—ä¿¡ ===');

    // ãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµãªã®ã§ã€ã™ã¹ã¦ã®å›ç­”ã‚’ handleInitialFormSubmit ã§å‡¦ç†
    handleInitialFormSubmit(e);

  } catch (error) {
    console.error('onFormSubmit error:', error);
    logError('onFormSubmit ã‚¨ãƒ©ãƒ¼', error.toString());

    try {
      const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;
      sendLineMessage(CONFIG.ADMIN_USER_ID, [{
        type: 'text',
        text: `ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼\n\nãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\nã‚¨ãƒ©ãƒ¼: ${error.toString()}\n\nå®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„`
      }], adminToken);
    } catch (notifyError) {
      console.error('ã‚¨ãƒ©ãƒ¼é€šçŸ¥å¤±æ•—:', notifyError);
    }
  }
}

/**
 * äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ï¼ˆLINEæ—¥æ™‚é¸æŠç‰ˆï¼‰
 * ãƒ•ã‚©ãƒ¼ãƒ ã§å€‹äººæƒ…å ±ã®ã¿å–å¾—ã€æ—¥æ™‚ã¯LINEã§é¸æŠ
 */
function handleInitialFormSubmit(e) {
  const startTime = Date.now();

  try {
    console.log('=== äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†é–‹å§‹ ===');

    const data = e.namedValues;

    // ãƒ˜ãƒ«ãƒ‘é–¢æ•°: å€¤ã‚’å®‰å…¨ã«å–å¾—
    const getValue = (key, defaultVal = '') => {
      return (data[key] && data[key][0]) ? data[key][0] : defaultVal;
    };

    // åŸºæœ¬æƒ…å ±
    const userId = getValue('ç®¡ç†ç”¨ID(âš ï¸å¤‰æ›´ã‚’åŠ ãˆãªã„ã§ãã ã•ã„)', null);
    const name = getValue('ãŠåå‰', 'ï¼ˆæœªå…¥åŠ›ï¼‰');
    const course = getValue('ã‚³ãƒ¼ã‚¹', null);

    // é€£çµ¡å…ˆæƒ…å ±
    const phone = getValue('é›»è©±ç•ªå·', 'æœªå…¥åŠ›');
    const postalCode = getValue('éƒµä¾¿ç•ªå·', '');
    const address = getValue('ã”ä½æ‰€', 'æœªå…¥åŠ›');

    console.log('å—ä¿¡ãƒ‡ãƒ¼ã‚¿ - userId:', userId, 'name:', name, 'course:', course);
    console.log('é€£çµ¡å…ˆæƒ…å ± - phone:', phone ? 'å…¥åŠ›ã‚ã‚Š' : 'ãªã—', 'address:', address ? 'å…¥åŠ›ã‚ã‚Š' : 'ãªã—');

    // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
    if (!userId || !course || !phone || !address) {
      console.error('å¿…é ˆé …ç›®ä¸è¶³ - userId:', userId, 'course:', course, 'phone:', phone, 'address:', address);
      return;
    }

    const requestId = generateRequestId();

    // â˜… äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜ï¼ˆæ—¥æ™‚ã¯å¾Œã§é¸æŠï¼‰
    saveBooking(requestId, {
      requestId: requestId,
      userId: userId,
      userName: name,
      desiredDateTime: null, // å¾Œã§è¨­å®š
      course: course,
      phone: phone,
      postalCode: postalCode,
      address: address,
      status: 'æ—¥æ™‚é¸æŠä¸­',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });

    // â˜… ç©ºã„ã¦ã„ã‚‹æ—¥ã‚’å–å¾—ï¼ˆ14æ—¥é–“ï¼‰
    const availableDates = getAvailableDates(14);

    if (availableDates.length === 0) {
      // ç©ºããŒãªã„å ´åˆ
      sendLineMessage(userId, [{
        type: 'text',
        text: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\nç¾åœ¨ã€äºˆç´„å¯èƒ½ãªæ—¥ç¨‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\nå¾Œæ—¥æ”¹ã‚ã¦ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
      }]);
      logAction('äºˆç´„ä¸å¯', userId, 'ç©ºãæ—¥ç¨‹ãªã—');
      return;
    }

    // â˜… ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã§æ—¥ä»˜é¸æŠã‚’è¡¨ç¤ºï¼ˆPush API - æœ‰æ–™1é€šç›®ï¼‰
    const quickReplyItems = availableDates.slice(0, 13).map(date => ({
      type: 'action',
      action: {
        type: 'postback',
        label: date.replace(/^\d{4}\//, ''), // å¹´ã‚’é™¤å»ã—ã¦è¡¨ç¤º
        data: `select_date_${requestId}_${date}`
      }
    }));

    const dateSelectMessage = {
      type: 'text',
      text: `${name} æ§˜\n\nãƒ•ã‚©ãƒ¼ãƒ ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚\n\nç¶šã‘ã¦ã€ã”å¸Œæœ›ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`,
      quickReply: {
        items: quickReplyItems
      }
    };

    sendLineMessage(userId, [dateSelectMessage]);
    logAction('æ—¥ä»˜é¸æŠé€ä¿¡', userId, requestId);

    const duration = Date.now() - startTime;
    console.log(`=== äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    console.error(`handleInitialFormSubmit error:`, error);
    logError('äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã‚¨ãƒ©ãƒ¼', error.toString());
  }
}

/**
 * æ—¥ä»˜é¸æŠå‡¦ç†ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã‹ã‚‰ï¼‰
 */
function handleDateSelection(requestId, selectedDate, userId, replyToken) {
  const startTime = Date.now();

  try {
    console.log('=== æ—¥ä»˜é¸æŠå‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId, 'é¸æŠæ—¥:', selectedDate);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      replyLineMessage(replyToken, [{
        type: 'text',
        text: 'ã‚¨ãƒ©ãƒ¼: äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nå†åº¦ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
      }]);
      return;
    }

    // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’ãƒ‘ãƒ¼ã‚¹
    const dateMatch = selectedDate.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})/);
    if (!dateMatch) {
      console.error('æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', selectedDate);
      replyLineMessage(replyToken, [{
        type: 'text',
        text: 'ã‚¨ãƒ©ãƒ¼: æ—¥ä»˜ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚\nå†åº¦ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
      }]);
      return;
    }

    const year = parseInt(dateMatch[1], 10);
    const month = parseInt(dateMatch[2], 10);
    const day = parseInt(dateMatch[3], 10);
    const targetDate = new Date(year, month - 1, day);

    // ãã®æ—¥ã®ç©ºãæ™‚é–“ã‚’å–å¾—
    const availableTimeSlots = getAvailableTimeSlots(targetDate);

    if (availableTimeSlots.length === 0) {
      // ç©ºãæ™‚é–“ãŒãªã„å ´åˆï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§åŸ‹ã¾ã£ãŸå¯èƒ½æ€§ï¼‰
      replyLineMessage(replyToken, [{
        type: 'text',
        text: `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\n${selectedDate} ã¯äºˆç´„ãŒåŸ‹ã¾ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚\n\nåˆ¥ã®æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`
      }]);

      // å†åº¦æ—¥ä»˜é¸æŠã‚’é€ä¿¡
      const availableDates = getAvailableDates(14);
      if (availableDates.length > 0) {
        const quickReplyItems = availableDates.slice(0, 13).map(date => ({
          type: 'action',
          action: {
            type: 'postback',
            label: date.replace(/^\d{4}\//, ''),
            data: `select_date_${requestId}_${date}`
          }
        }));

        sendLineMessage(userId, [{
          type: 'text',
          text: 'åˆ¥ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
          quickReply: { items: quickReplyItems }
        }]);
      }
      return;
    }

    // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã«é¸æŠæ—¥ã‚’ä¸€æ™‚ä¿å­˜
    booking.selectedDate = selectedDate;
    booking.updatedAt = new Date().toISOString();
    saveBooking(requestId, booking);

    // â˜… ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã§æ™‚é–“é¸æŠã‚’è¡¨ç¤ºï¼ˆReply API - ç„¡æ–™ï¼‰
    const quickReplyItems = availableTimeSlots.slice(0, 13).map(time => ({
      type: 'action',
      action: {
        type: 'postback',
        label: time,
        data: `select_time_${requestId}_${selectedDate}_${time}`
      }
    }));

    replyLineMessage(replyToken, [{
      type: 'text',
      text: `${selectedDate} ã®ç©ºãæ™‚é–“ã§ã™ã€‚\n\nã”å¸Œæœ›ã®æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`,
      quickReply: {
        items: quickReplyItems
      }
    }]);

    logAction('æ™‚é–“é¸æŠé€ä¿¡', userId, `${requestId} - ${selectedDate}`);

    const duration = Date.now() - startTime;
    console.log(`=== æ—¥ä»˜é¸æŠå‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    console.error('handleDateSelection error:', error);
    logError('æ—¥ä»˜é¸æŠå‡¦ç†ã‚¨ãƒ©ãƒ¼', error.toString());
    replyLineMessage(replyToken, [{
      type: 'text',
      text: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nå†åº¦ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
    }]);
  }
}

/**
 * æ™‚é–“é¸æŠå‡¦ç†ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã‹ã‚‰ï¼‰
 */
function handleTimeSelection(requestId, selectedDate, selectedTime, userId, replyToken) {
  const startTime = Date.now();

  try {
    console.log('=== æ™‚é–“é¸æŠå‡¦ç†é–‹å§‹ ===');
    console.log('å—ä»˜ç•ªå·:', requestId, 'æ—¥æ™‚:', selectedDate, selectedTime);

    const booking = getBooking(requestId);

    if (!booking) {
      console.error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      replyLineMessage(replyToken, [{
        type: 'text',
        text: 'ã‚¨ãƒ©ãƒ¼: äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nå†åº¦ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
      }]);
      return;
    }

    // æ—¥æ™‚ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
    const dateMatch = selectedDate.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})/);
    const timeMatch = selectedTime.match(/^(\d{1,2}):(\d{2})$/);

    if (!dateMatch || !timeMatch) {
      console.error('æ—¥æ™‚ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', selectedDate, selectedTime);
      replyLineMessage(replyToken, [{
        type: 'text',
        text: 'ã‚¨ãƒ©ãƒ¼: æ—¥æ™‚ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚\nå†åº¦ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
      }]);
      return;
    }

    const year = parseInt(dateMatch[1], 10);
    const month = parseInt(dateMatch[2], 10);
    const day = parseInt(dateMatch[3], 10);
    const hour = parseInt(timeMatch[1], 10);
    const minute = parseInt(timeMatch[2], 10);

    const reservationDate = new Date(year, month - 1, day, hour, minute, 0, 0);
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const desiredDateTime = `${dateStr} ${selectedTime}`;

    // â˜… æœ€çµ‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚ï¼‰
    const availability = checkCalendarFast(reservationDate, booking.course);

    if (!availability.available) {
      replyLineMessage(replyToken, [{
        type: 'text',
        text: `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\n${availability.reason}\n\nåˆ¥ã®æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`
      }]);

      // å†åº¦æ™‚é–“é¸æŠã‚’é€ä¿¡
      const targetDate = new Date(year, month - 1, day);
      const availableTimeSlots = getAvailableTimeSlots(targetDate);

      if (availableTimeSlots.length > 0) {
        const quickReplyItems = availableTimeSlots.slice(0, 13).map(time => ({
          type: 'action',
          action: {
            type: 'postback',
            label: time,
            data: `select_time_${requestId}_${selectedDate}_${time}`
          }
        }));

        sendLineMessage(userId, [{
          type: 'text',
          text: 'åˆ¥ã®æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
          quickReply: { items: quickReplyItems }
        }]);
      }
      return;
    }

    // â˜… äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    booking.desiredDateTime = desiredDateTime;
    booking.status = 'æ‰¿èªå¾…ã¡';
    booking.updatedAt = new Date().toISOString();
    saveBooking(requestId, booking);

    // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸å—ä»˜å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆReply API - ç„¡æ–™ï¼‰
    const name = booking.userName || 'ï¼ˆæœªè¨­å®šï¼‰';
    replyLineMessage(replyToken, [{
      type: 'text',
      text: `${name} æ§˜\n\nã”äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚\n\n` +
            `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
            `ğŸ“… ${desiredDateTime}\n` +
            `ğŸ’¼ ${booking.course}\n` +
            `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
            `å†…å®¹ã‚’ç¢ºèªå¾Œã€æ‹…å½“è€…ã‚ˆã‚Šã€Œäºˆç´„ç¢ºå®šã€ã®ã”é€£çµ¡ã‚’ã„ãŸã—ã¾ã™ã€‚\n\n` +
            `ï¼ˆâ€»ã¾ã äºˆç´„ã¯ç¢ºå®šã—ã¦ãŠã‚Šã¾ã›ã‚“ï¼‰`
    }]);

    // â˜… ç®¡ç†è€…ã¸ã®é€šçŸ¥ï¼ˆPush APIï¼‰
    const adminToken = CONFIG.ADMIN_BOT_TOKEN || null;

    const adminMessages = [
      {
        type: 'text',
        text: `æ–°è¦äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `${name} æ§˜\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
              `ğŸ“… ${desiredDateTime}\n` +
              `ğŸ’¼ ${booking.course}\n\n` +
              `ğŸ“ ${booking.phone}\n` +
              `ğŸ  ${booking.postalCode}\n${booking.address}\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
      },
      {
        type: 'template',
        altText: 'äºˆç´„ã®ç¢ºèª',
        template: {
          type: 'confirm',
          text: 'ã“ã®äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã™ã‹ï¼Ÿ',
          actions: [
            {
              type: 'postback',
              label: 'å—ã‘ä»˜ã‘ã‚‹',
              data: `approve_${requestId}`
            },
            {
              type: 'postback',
              label: 'ãŠæ–­ã‚Šã™ã‚‹',
              data: `reject_${requestId}`
            }
          ]
        }
      }
    ];

    sendLineMessage(CONFIG.ADMIN_USER_ID, adminMessages, adminToken);

    logAction('äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡', userId, `${requestId} - ${desiredDateTime}`);

    const duration = Date.now() - startTime;
    console.log(`=== æ™‚é–“é¸æŠå‡¦ç†å®Œäº† (${duration}ms) ===`);

  } catch (error) {
    console.error('handleTimeSelection error:', error);
    logError('æ™‚é–“é¸æŠå‡¦ç†ã‚¨ãƒ©ãƒ¼', error.toString());
    replyLineMessage(replyToken, [{
      type: 'text',
      text: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nå†åº¦ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚'
    }]);
  }
}

// handleApprovedFormSubmit ã¯å»ƒæ­¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ 1å›å®Œçµã®ãŸã‚ï¼‰

/**
 * ãƒˆãƒªã‚¬ãƒ¼è¨­å®šç”¨é–¢æ•°ï¼ˆæ‰‹å‹•å®Ÿè¡Œç”¨ï¼‰
 * 1æ™‚é–“ã”ã¨ã«ãƒ•ã‚©ãƒ¼ãƒ ã®é¸æŠè‚¢ã‚’æ›´æ–°ã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
 */
function setupTriggers() {
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'updateFormDateChoices') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // æ–°ã—ã„ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆï¼ˆ1æ™‚é–“ã”ã¨ï¼‰
  ScriptApp.newTrigger('updateFormDateChoices')
    .timeBased()
    .everyHours(1)
    .create();

  console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ é¸æŠè‚¢æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆ1æ™‚é–“ã”ã¨ï¼‰');
}
